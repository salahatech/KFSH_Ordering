generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & RBAC ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  isActive      Boolean   @default(true)
  roleId        String
  role          Role      @relation(fields: [roleId], references: [id])
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  driver        Driver?
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  notifications Notification[]
  batchOperators BatchOperator[]
  qcResults     QCResult[]
  batchReleases BatchRelease[]
  approvalRequests ApprovalRequest[] @relation("ApprovalRequester")
  approvalActions  ApprovalAction[]  @relation("ApprovalActor")
  dispensedDoses   DoseUnit[]        @relation("DoseDispenser")
  orderHistories   OrderHistory[]
  batchEvents      BatchEvent[]
  uploadedDocuments CustomerDocument[]
  uploadedLocationPhotos CustomerLocationPhoto[] @relation("LocationPhotoUploader")
  submittedPaymentRequests PaymentRequest[] @relation("PaymentRequestSubmitter")
  reviewedPaymentRequests  PaymentRequest[] @relation("PaymentRequestReviewer")
  confirmedReceipts        ReceiptVoucher[] @relation("ReceiptConfirmer")
  approvedInvoices         Invoice[]        @relation("InvoiceApprover")
  invoiceEvents            InvoiceEvent[]   @relation("InvoiceEventUser")
  eSignatures              ESignature[]
  samplesTaken             Sample[]         @relation("SampleTaker")
  testResults              TestResult[]     @relation("TestAnalyst")
  oosOpened                OOSCase[]        @relation("OOSOpener")
  oosClosed                OOSCase[]        @relation("OOSCloser")
  preference               UserPreference?
  attachments              Attachment[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Role {
  id            String         @id @default(uuid())
  name          String         @unique
  description   String?
  permissions   Permission[]
  users         User[]
  approvalSteps ApprovalStep[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  roles       Role[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ==================== CUSTOMER & COMPLIANCE ====================

model Customer {
  id                  String    @id @default(uuid())
  code                String    @unique
  name                String
  nameEn              String?
  nameAr              String?
  email               String?
  mobile              String?
  phone               String?
  
  crNumber            String?
  taxNumber           String?
  
  fullAddress         String?
  shortAddress        String?
  buildingNo          String?
  street              String?
  secondaryNo         String?
  district            String?
  postalCode          String?
  cityId              String?
  city                SettingCity?   @relation(fields: [cityId], references: [id])
  regionId            String?
  region              SettingRegion? @relation(fields: [regionId], references: [id])
  countryId           String?
  country             SettingCountry? @relation(fields: [countryId], references: [id])
  address             String?
  
  latitude            Decimal?  @db.Decimal(9, 6)
  longitude           Decimal?  @db.Decimal(9, 6)
  
  logoUrl             String?
  
  licenseNumber       String?
  licenseExpiryDate   DateTime?
  deliveryWindowStart String?
  deliveryWindowEnd   String?
  preferredDeliveryTime String?
  travelTimeMinutes   Int       @default(60)
  categoryId          String?
  category            SettingCategory? @relation(fields: [categoryId], references: [id])
  isActive            Boolean   @default(true)
  
  permittedProducts   CustomerProduct[]
  contacts            CustomerContact[]
  documents           CustomerDocument[]
  locationPhotos      CustomerLocationPhoto[]
  orders              Order[]
  users               User[]
  shipments           Shipment[]
  reservations        Reservation[]
  contracts           Contract[]
  invoices            Invoice[]
  paymentRequests     PaymentRequest[]
  receiptVouchers     ReceiptVoucher[]
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

enum DocumentType {
  CR
  TAX_CERT
  LICENSE
  CONTRACT
  NDA
  OTHER
}

model CustomerDocument {
  id              String       @id @default(uuid())
  customerId      String
  customer        Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  docType         DocumentType
  docName         String
  fileUrl         String
  fileSizeBytes   Int
  mimeType        String
  uploadedByUserId String?
  uploadedBy      User?        @relation(fields: [uploadedByUserId], references: [id])
  uploadedAt      DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model CustomerLocationPhoto {
  id              String    @id @default(uuid())
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  photoUrl        String
  caption         String?
  fileSizeBytes   Int
  mimeType        String
  uploadedByUserId String?
  uploadedBy      User?     @relation("LocationPhotoUploader", fields: [uploadedByUserId], references: [id])
  uploadedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model CustomerContact {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name       String
  title      String?
  email      String
  phone      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CustomerProduct {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  isApproved Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([customerId, productId])
}

// ==================== PRODUCT CATALOG ====================

enum ProductType {
  PET
  SPECT
  THERAPY
}

enum ProductionMethod {
  CYCLOTRON
  GENERATOR
  KIT
}

model Product {
  id                    String           @id @default(uuid())
  name                  String
  code                  String           @unique
  productType           ProductType
  radionuclide          String
  halfLifeMinutes       Float
  shelfLifeMinutes      Float
  minConcentration      Float?
  maxConcentration      Float?
  standardDose          Float?
  doseUnit              String           @default("mCi")
  productionMethod      ProductionMethod
  synthesisTimeMinutes  Int              @default(60)
  qcTimeMinutes         Int              @default(30)
  packagingTimeMinutes  Int              @default(15)
  packagingType         String?
  transportConstraints  String?
  calibrationTimeOffset Int              @default(0)
  overagePercent        Float            @default(10)
  isActive              Boolean          @default(true)
  qcTemplates           QCTemplate[]
  customerProducts      CustomerProduct[]
  orders                Order[]
  batches               Batch[]
  reservations          Reservation[]
  contractPriceItems    ContractPriceItem[]
  invoiceItems          InvoiceItem[]
  timeStandards         TimeStandard[]
  testSpecs             TestSpec[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
}

model QCTemplate {
  id                String     @id @default(uuid())
  productId         String
  product           Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  testName          String
  testMethod        String?
  acceptanceCriteria String
  minValue          Float?
  maxValue          Float?
  unit              String?
  isRequired        Boolean    @default(true)
  sortOrder         Int        @default(0)
  qcResults         QCResult[]
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

// ==================== ORDERING ====================

enum OrderStatus {
  DRAFT
  SUBMITTED
  VALIDATED
  SCHEDULED
  IN_PRODUCTION
  QC_PENDING
  RELEASED
  DISPATCHED
  DELIVERED
  CANCELLED
  REJECTED
  FAILED_QC
  REWORK
}

model Order {
  id                    String      @id @default(uuid())
  orderNumber           String      @unique
  customerId            String
  customer              Customer    @relation(fields: [customerId], references: [id])
  productId             String
  product               Product     @relation(fields: [productId], references: [id])
  deliveryDate          DateTime
  deliveryTimeStart     DateTime
  deliveryTimeEnd       DateTime
  requestedActivity     Float
  activityUnit          String      @default("mCi")
  numberOfDoses         Int?
  injectionTime         DateTime?
  patientCount          Int?
  specialNotes          String?
  hospitalOrderReference String?
  committedDispensingMinutes Int?
  calculatedProductionActivity Float?
  calculatedCalibrationTime    DateTime?
  status                OrderStatus @default(DRAFT)
  version               Int         @default(1)
  batchId               String?
  batch                 Batch?      @relation(fields: [batchId], references: [id])
  shipmentId            String?
  shipment              Shipment?   @relation(fields: [shipmentId], references: [id])
  reservationId         String?
  reservation           Reservation? @relation(fields: [reservationId], references: [id])
  orderHistory          OrderHistory[]
  doseUnits             DoseUnit[]
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}

model OrderHistory {
  id          String       @id @default(uuid())
  orderId     String
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStatus  OrderStatus?
  toStatus    OrderStatus
  changedBy   String?
  changedByUser User?      @relation(fields: [changedBy], references: [id])
  role        String?
  changeNotes String?
  metadata    Json?
  snapshot    Json?
  createdAt   DateTime     @default(now())

  @@index([orderId])
}

// ==================== BATCH & LOT MANAGEMENT ====================

enum BatchStatus {
  PLANNED
  SCHEDULED
  IN_PRODUCTION
  PRODUCTION_COMPLETE
  QC_PENDING
  QC_IN_PROGRESS
  QC_PASSED
  QP_REVIEW
  RELEASED
  DISPENSING_IN_PROGRESS
  DISPENSED
  PACKED
  DISPATCHED
  CLOSED
  ON_HOLD
  REJECTED
  FAILED_QC
  CANCELLED
  DEVIATION_OPEN
}

model BatchEvent {
  id          String      @id @default(uuid())
  batchId     String
  batch       Batch       @relation(fields: [batchId], references: [id], onDelete: Cascade)
  eventType   String      @default("STATUS_CHANGE")
  fromStatus  BatchStatus?
  toStatus    BatchStatus?
  actorId     String?
  actor       User?       @relation(fields: [actorId], references: [id])
  actorRole   String?
  note        String?
  metadata    Json?
  traceId     String?
  createdAt   DateTime    @default(now())

  @@index([batchId])
  @@index([createdAt])
}

model Batch {
  id                  String        @id @default(uuid())
  batchNumber         String        @unique
  productId           String
  product             Product       @relation(fields: [productId], references: [id])
  plannedStartTime    DateTime
  plannedEndTime      DateTime
  actualStartTime     DateTime?
  actualEndTime       DateTime?
  targetActivity      Float
  actualActivity      Float?
  activityUnit        String        @default("mCi")
  calibrationTime     DateTime?
  synthesisModuleId   String?
  synthesisModule     Equipment?    @relation("SynthesisModule", fields: [synthesisModuleId], references: [id])
  hotCellId           String?
  hotCell             Equipment?    @relation("HotCell", fields: [hotCellId], references: [id])
  status              BatchStatus   @default(PLANNED)
  notes               String?
  orders              Order[]
  operators           BatchOperator[]
  materialLots        BatchMaterialLot[]
  qcResults           QCResult[]
  batchReleases       BatchRelease[]
  doseUnits           DoseUnit[]
  events              BatchEvent[]
  samples             Sample[]
  oosCases            OOSCase[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

model BatchOperator {
  id        String   @id @default(uuid())
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String?
  startTime DateTime?
  endTime   DateTime?
  createdAt DateTime @default(now())

  @@unique([batchId, userId])
}

model Equipment {
  id                String   @id @default(uuid())
  name              String
  code              String   @unique
  type              String
  location          String?
  isAvailable       Boolean  @default(true)
  maintenanceNotes  String?
  synthesisBatches  Batch[]  @relation("SynthesisModule")
  hotCellBatches    Batch[]  @relation("HotCell")
  resourceCalendars ResourceCalendar[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model MaterialLot {
  id            String   @id @default(uuid())
  materialName  String
  materialCode  String
  lotNumber     String
  expiryDate    DateTime
  quantity      Float
  unit          String
  supplierId    String?
  isActive      Boolean  @default(true)
  batchMaterialLots BatchMaterialLot[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([materialCode, lotNumber])
}

model BatchMaterialLot {
  id            String      @id @default(uuid())
  batchId       String
  batch         Batch       @relation(fields: [batchId], references: [id], onDelete: Cascade)
  materialLotId String
  materialLot   MaterialLot @relation(fields: [materialLotId], references: [id])
  quantityUsed  Float
  createdAt     DateTime    @default(now())

  @@unique([batchId, materialLotId])
}

// ==================== QC MODULE ====================

enum QCResultStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
}

model QCResult {
  id            String         @id @default(uuid())
  batchId       String
  batch         Batch          @relation(fields: [batchId], references: [id], onDelete: Cascade)
  templateId    String
  template      QCTemplate     @relation(fields: [templateId], references: [id])
  numericResult Float?
  textResult    String?
  passed        Boolean?
  status        QCResultStatus @default(PENDING)
  testedById    String?
  testedBy      User?          @relation(fields: [testedById], references: [id])
  testedAt      DateTime?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model BatchRelease {
  id               String           @id @default(uuid())
  batchId          String
  batch            Batch            @relation(fields: [batchId], references: [id], onDelete: Cascade)
  releasedById     String
  releasedBy       User             @relation(fields: [releasedById], references: [id])
  releaseType      String           @default("FULL")
  disposition      BatchDisposition @default(RELEASE)
  electronicSignature String
  signatureTimestamp DateTime
  meaning          String?
  reason           String?
  coaFilePath      String?
  createdAt        DateTime         @default(now())
}

enum BatchDisposition {
  HOLD
  RELEASE
  REJECT
}

// ==================== E-SIGNATURE ====================

enum ESignatureScope {
  BATCH_RELEASE
  DEVIATION_APPROVAL
  MASTERDATA_CHANGE
  RECIPE_ACTIVATION
  PO_APPROVAL
  FINANCIAL_APPROVAL
  QC_APPROVAL
  DISPENSING_APPROVAL
}

model ESignature {
  id          String          @id @default(uuid())
  scope       ESignatureScope
  entityType  String
  entityId    String
  signedById  String
  signedBy    User            @relation(fields: [signedById], references: [id])
  signedAt    DateTime        @default(now())
  meaning     String
  comment     String?
  metadata    Json?
  createdAt   DateTime        @default(now())

  @@index([entityType, entityId])
  @@index([signedById])
}

// ==================== QMS - SAMPLE & TEST MANAGEMENT ====================

enum SampleStatus {
  COLLECTED
  IN_TESTING
  TESTED
  APPROVED
  REJECTED
}

model Sample {
  id          String       @id @default(uuid())
  sampleNumber String      @unique
  batchId     String
  batch       Batch        @relation(fields: [batchId], references: [id], onDelete: Cascade)
  sampleType  String
  takenAt     DateTime     @default(now())
  takenById   String
  takenBy     User         @relation("SampleTaker", fields: [takenById], references: [id])
  status      SampleStatus @default(COLLECTED)
  notes       String?
  testResults TestResult[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([batchId])
}

model TestSpec {
  id          String       @id @default(uuid())
  productId   String
  product     Product      @relation(fields: [productId], references: [id])
  testName    String
  testMethod  String?
  unit        String?
  minValue    Float?
  maxValue    Float?
  required    Boolean      @default(true)
  sortOrder   Int          @default(0)
  isActive    Boolean      @default(true)
  testResults TestResult[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([productId, testName])
}

model TestResult {
  id          String   @id @default(uuid())
  sampleId    String
  sample      Sample   @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  testSpecId  String
  testSpec    TestSpec @relation(fields: [testSpecId], references: [id])
  numericValue Float?
  textValue   String?
  passFail    Boolean?
  measuredAt  DateTime @default(now())
  analystId   String
  analyst     User     @relation("TestAnalyst", fields: [analystId], references: [id])
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sampleId])
  @@index([testSpecId])
}

model OOSCase {
  id          String   @id @default(uuid())
  caseNumber  String   @unique
  batchId     String
  batch       Batch    @relation(fields: [batchId], references: [id])
  openedAt    DateTime @default(now())
  openedById  String
  openedBy    User     @relation("OOSOpener", fields: [openedById], references: [id])
  reason      String
  investigation String?
  conclusion  String?
  status      String   @default("OPEN")
  closedAt    DateTime?
  closedById  String?
  closedBy    User?    @relation("OOSCloser", fields: [closedById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([batchId])
  @@index([status])
}

// ==================== LOGISTICS ====================

enum ShipmentStatus {
  DRAFT
  READY_TO_PACK
  PACKED
  ASSIGNED_TO_DRIVER
  ACCEPTED_BY_DRIVER
  PICKED_UP
  IN_TRANSIT
  ARRIVED
  DELIVERED
  DELIVERY_FAILED
  RETURNED
  CANCELLED
  DELAYED
}

enum VehicleType {
  CAR
  VAN
  MOTORCYCLE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
}

enum ShipmentPriority {
  NORMAL
  URGENT
}

// ==================== DRIVER MANAGEMENT ====================

model Driver {
  id                String       @id @default(uuid())
  fullName          String
  mobile            String
  email             String?
  nationalId        String?
  driverLicenseNo   String?
  licenseExpiryDate DateTime?
  vehicleType       VehicleType  @default(CAR)
  vehiclePlateNo    String?
  vehicleModel      String?
  status            DriverStatus @default(ACTIVE)
  photoUrl          String?
  userId            String?      @unique
  user              User?        @relation(fields: [userId], references: [id])
  shipments         Shipment[]
  assignedShipments Shipment[]   @relation("ShipmentAssigner")
  availability      DriverAvailability[]
  proofOfDeliveries ProofOfDelivery[]
  shipmentEvents    ShipmentEvent[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

model DriverAvailability {
  id          String   @id @default(uuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id])
  date        DateTime
  startTime   String
  endTime     String
  isAvailable Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ShipmentEvent {
  id          String   @id @default(uuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id])
  eventType   String
  fromStatus  ShipmentStatus?
  toStatus    ShipmentStatus?
  driverId    String?
  driver      Driver?  @relation(fields: [driverId], references: [id])
  userId      String?
  notes       String?
  latitude    Float?
  longitude   Float?
  metadata    Json?
  createdAt   DateTime @default(now())
}

model ProofOfDelivery {
  id              String    @id @default(uuid())
  shipmentId      String    @unique
  shipment        Shipment  @relation(fields: [shipmentId], references: [id])
  deliveredAt     DateTime
  receiverName    String
  receiverMobile  String?
  receiverIdType  String?
  signatureFileUrl String?
  gpsLat          Float?
  gpsLng          Float?
  notes           String?
  capturedByDriverId String?
  capturedByDriver   Driver?  @relation(fields: [capturedByDriverId], references: [id])
  photos          ProofOfDeliveryPhoto[]
  createdAt       DateTime  @default(now())
}

model ProofOfDeliveryPhoto {
  id        String          @id @default(uuid())
  podId     String
  pod       ProofOfDelivery @relation(fields: [podId], references: [id])
  fileUrl   String
  caption   String?
  createdAt DateTime        @default(now())
}

model Shipment {
  id                     String           @id @default(uuid())
  shipmentNumber         String           @unique
  customerId             String
  customer               Customer         @relation(fields: [customerId], references: [id])
  driverId               String?
  driver                 Driver?          @relation(fields: [driverId], references: [id])
  assignedAt             DateTime?
  assignedByDriverId     String?
  assignedByDriver       Driver?          @relation("ShipmentAssigner", fields: [assignedByDriverId], references: [id])
  courierId              String?
  courierName            String?
  vehicleInfo            String?
  routeInfo              String?
  scheduledPickupAt      DateTime?
  scheduledDeliveryAt    DateTime?
  scheduledDepartureTime DateTime?
  actualDepartureTime    DateTime?
  expectedArrivalTime    DateTime?
  actualArrivalTime      DateTime?
  pickupAddress          String?
  deliveryAddress        String?
  deliveryLat            Float?
  deliveryLng            Float?
  specialHandling        String?
  currentLocationLat     Float?
  currentLocationLng     Float?
  lastCheckpointAt       DateTime?
  priority               ShipmentPriority @default(NORMAL)
  activityAtDispatch     Float?
  activityAtDelivery     Float?
  receiverName           String?
  receiverSignature      String?
  status                 ShipmentStatus   @default(PACKED)
  notes                  String?
  driverNotes            String?
  orders                 Order[]
  doseUnits              DoseUnit[]
  events                 ShipmentEvent[]
  proofOfDelivery        ProofOfDelivery?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  ORDER_SUBMITTED
  ORDER_VALIDATED
  SCHEDULE_CHANGED
  QC_PASSED
  QC_FAILED
  BATCH_RELEASED
  DISPATCH_UPDATE
  DELIVERY_UPDATE
  SYSTEM
}

model Notification {
  id          String           @id @default(uuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String
  message     String
  isRead      Boolean          @default(false)
  relatedId   String?
  relatedType String?
  createdAt   DateTime         @default(now())
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  action      String
  entityType  String
  entityId    String?
  actorRole   String?
  traceId     String?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([traceId])
  @@index([createdAt])
}

// ==================== CONFIGURATION ====================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  dataType  String   @default("string")
  category  String?
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductionSlot {
  id            String   @id @default(uuid())
  slotDate      DateTime
  slotStartTime DateTime
  slotEndTime   DateTime
  equipmentId   String?
  equipmentType String
  isAvailable   Boolean  @default(true)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ==================== WORKFLOW APPROVAL SYSTEM ====================

enum WorkflowEntityType {
  ORDER
  BATCH
  QC_RESULT
  BATCH_RELEASE
  SHIPMENT
  CUSTOMER
  PRODUCT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
  CANCELLED
}

model WorkflowDefinition {
  id                String              @id @default(uuid())
  name              String              @unique
  entityType        WorkflowEntityType
  triggerStatus     String?
  description       String?
  isActive          Boolean             @default(true)
  requiresAllSteps  Boolean             @default(true)
  steps             ApprovalStep[]
  approvalRequests  ApprovalRequest[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model ApprovalStep {
  id                  String             @id @default(uuid())
  workflowId          String
  workflow            WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepOrder           Int
  stepName            String
  description         String?
  approverRoleId      String
  approverRole        Role               @relation(fields: [approverRoleId], references: [id])
  timeoutHours        Int?
  isRequired          Boolean            @default(true)
  canDelegate         Boolean            @default(false)
  approvalActions     ApprovalAction[]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@unique([workflowId, stepOrder])
}

model ApprovalRequest {
  id                String             @id @default(uuid())
  workflowId        String
  workflow          WorkflowDefinition @relation(fields: [workflowId], references: [id])
  entityType        WorkflowEntityType
  entityId          String
  requestedById     String
  requestedBy       User               @relation("ApprovalRequester", fields: [requestedById], references: [id])
  currentStepOrder  Int                @default(1)
  status            ApprovalStatus     @default(PENDING)
  priority          String             @default("NORMAL")
  dueDate           DateTime?
  completedAt       DateTime?
  notes             String?
  actions           ApprovalAction[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([entityType, entityId])
  @@index([status])
}

model ApprovalAction {
  id                String          @id @default(uuid())
  approvalRequestId String
  approvalRequest   ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)
  stepId            String
  step              ApprovalStep    @relation(fields: [stepId], references: [id])
  actionById        String
  actionBy          User            @relation("ApprovalActor", fields: [actionById], references: [id])
  action            ApprovalStatus
  comments          String?
  signature         String?
  actionAt          DateTime        @default(now())

  @@index([approvalRequestId])
}

// ==================== DOSE DISPENSING ====================

enum DoseUnitStatus {
  CREATED
  LABELED
  DISPENSED
  SHIPPED
  DELIVERED
  CANCELLED
  WASTED
}

model DoseUnit {
  id                  String         @id @default(uuid())
  doseNumber          String         @unique
  batchId             String
  batch               Batch          @relation(fields: [batchId], references: [id])
  orderId             String?
  order               Order?         @relation(fields: [orderId], references: [id])
  patientReference    String?
  requestedActivity   Float
  dispensedActivity   Float?
  calibrationTime     DateTime?
  activityUnit        String         @default("mCi")
  volume              Float?
  volumeUnit          String         @default("mL")
  containerType       String?
  labelData           Json?
  labelPrinted        Boolean        @default(false)
  labelPrintedAt      DateTime?
  dispensedById       String?
  dispensedBy         User?          @relation("DoseDispenser", fields: [dispensedById], references: [id])
  dispensedAt         DateTime?
  status              DoseUnitStatus @default(CREATED)
  releaseInheritedFromBatch Boolean  @default(true)
  notes               String?
  shipmentId          String?
  shipment            Shipment?      @relation(fields: [shipmentId], references: [id])
  invoiceItemId       String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

// ==================== CAPACITY & SLOT MANAGEMENT ====================

enum ResourceType {
  CYCLOTRON
  SYNTHESIS_MODULE
  HOT_CELL
  DISPENSING_CELL
  QC_LAB
}

model ResourceCalendar {
  id              String       @id @default(uuid())
  resourceId      String
  resource        Equipment    @relation(fields: [resourceId], references: [id])
  date            DateTime     @db.Date
  startTime       DateTime
  endTime         DateTime
  capacityMinutes Int
  usedMinutes     Int          @default(0)
  isAvailable     Boolean      @default(true)
  notes           String?
  slots           DeliverySlot[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([resourceId, date])
}

model DeliveryWindow {
  id              String         @id @default(uuid())
  name            String
  date            DateTime       @db.Date
  startTime       DateTime
  endTime         DateTime
  capacityMinutes Int
  usedMinutes     Int            @default(0)
  isActive        Boolean        @default(true)
  slots           DeliverySlot[]
  reservations    Reservation[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([date, startTime, endTime])
}

model DeliverySlot {
  id                String           @id @default(uuid())
  windowId          String
  window            DeliveryWindow   @relation(fields: [windowId], references: [id], onDelete: Cascade)
  resourceCalendarId String?
  resourceCalendar  ResourceCalendar? @relation(fields: [resourceCalendarId], references: [id])
  slotTime          DateTime
  durationMinutes   Int
  capacityMinutes   Int
  usedMinutes       Int              @default(0)
  isAvailable       Boolean          @default(true)
  reservations      Reservation[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([windowId, slotTime])
}

// ==================== RESERVATIONS ====================

enum ReservationStatus {
  TENTATIVE
  CONFIRMED
  CONVERTED
  CANCELLED
  EXPIRED
}

model Reservation {
  id                String            @id @default(uuid())
  reservationNumber String            @unique
  customerId        String
  customer          Customer          @relation(fields: [customerId], references: [id])
  productId         String
  product           Product           @relation(fields: [productId], references: [id])
  windowId          String?
  window            DeliveryWindow?   @relation(fields: [windowId], references: [id])
  slotId            String?
  slot              DeliverySlot?     @relation(fields: [slotId], references: [id])
  requestedDate     DateTime
  requestedActivity Float
  activityUnit      String            @default("mCi")
  estimatedMinutes  Int
  numberOfDoses     Int               @default(1)
  status            ReservationStatus @default(TENTATIVE)
  convertedOrderId  String?
  expiresAt         DateTime?
  notes             String?
  createdById       String?
  orders            Order[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([customerId, requestedDate])
  @@index([status])
}

// ==================== CONTRACTS & PRICING ====================

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

model Contract {
  id              String         @id @default(uuid())
  contractNumber  String         @unique
  customerId      String
  customer        Customer       @relation(fields: [customerId], references: [id])
  name            String
  startDate       DateTime
  endDate         DateTime
  paymentTermsDays Int           @default(30)
  creditLimit     Float?
  discountPercent Float          @default(0)
  status          ContractStatus @default(DRAFT)
  notes           String?
  priceItems      ContractPriceItem[]
  invoices        Invoice[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([customerId])
  @@index([status])
}

model ContractPriceItem {
  id              String   @id @default(uuid())
  contractId      String
  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  unitPrice       Float
  priceUnit       String   @default("per mCi")
  minimumQuantity Float?
  discountPercent Float    @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([contractId, productId])
}

// ==================== INVOICING & AR ====================

enum InvoiceStatus {
  DRAFT
  PENDING_APPROVAL
  ISSUED_POSTED
  PARTIALLY_PAID
  PAID
  CLOSED_ARCHIVED
  CANCELLED_VOIDED
  OVERDUE
  DISPUTED
}

enum InvoiceGenerationTrigger {
  ON_DELIVERED
  ON_DISPATCHED
  ON_QP_RELEASED
  MANUAL_ONLY
}

model Invoice {
  id                  String        @id @default(uuid())
  invoiceNumber       String        @unique
  customerId          String
  customer            Customer      @relation(fields: [customerId], references: [id])
  contractId          String?
  contract            Contract?     @relation(fields: [contractId], references: [id])
  orderId             String?
  shipmentId          String?
  invoiceDate         DateTime      @default(now())
  dueDate             DateTime
  subtotal            Float         @default(0)
  taxAmount           Float         @default(0)
  discountAmount      Float         @default(0)
  totalAmount         Float         @default(0)
  paidAmount          Float         @default(0)
  remainingAmount     Float         @default(0)
  currency            String        @default("SAR")
  fxRateToSAR         Float         @default(1)
  totalAmountSAR      Float         @default(0)
  allowPartialPayment Boolean       @default(true)
  minInstallmentAmount Float?
  status              InvoiceStatus @default(DRAFT)
  triggerSource       InvoiceGenerationTrigger?
  postedAt            DateTime?
  issuedAt            DateTime?
  closedAt            DateTime?
  approvedByUserId    String?
  approvedBy          User?         @relation("InvoiceApprover", fields: [approvedByUserId], references: [id])
  notes               String?
  items               InvoiceItem[]
  payments            Payment[]
  paymentRequests     PaymentRequest[]
  receiptVouchers     ReceiptVoucher[]
  events              InvoiceEvent[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([dueDate])
  @@index([orderId])
  @@index([shipmentId])
}

model InvoiceEvent {
  id          String   @id @default(uuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  eventType   String
  description String?
  userId      String?
  user        User?    @relation("InvoiceEventUser", fields: [userId], references: [id])
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([invoiceId])
  @@index([eventType])
}

model PaymentEvent {
  id               String   @id @default(uuid())
  paymentRequestId String?
  receiptVoucherId String?
  eventType        String
  description      String?
  userId           String?
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([paymentRequestId])
  @@index([receiptVoucherId])
}

model InvoiceItem {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  orderId         String?
  doseUnitId      String?
  description     String
  productId       String?
  product         Product? @relation(fields: [productId], references: [id])
  quantity        Float
  unitPrice       Float
  discountPercent Float    @default(0)
  taxPercent      Float    @default(0)
  lineTotal       Float
  createdAt       DateTime @default(now())
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paymentDate     DateTime @default(now())
  amount          Float
  amountSAR       Float    @default(0)
  paymentMethod   String
  referenceNumber String?
  notes           String?
  receiptVoucherId String?
  receiptVoucher  ReceiptVoucher? @relation(fields: [receiptVoucherId], references: [id])
  createdAt       DateTime @default(now())
}

enum PaymentRequestStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  REJECTED
}

model PaymentRequest {
  id              String               @id @default(uuid())
  invoiceId       String
  invoice         Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  customerId      String
  customer        Customer             @relation(fields: [customerId], references: [id])
  amount          Float
  amountSAR       Float                @default(0)
  currency        String               @default("SAR")
  paymentMethod   String
  referenceNumber String?
  proofUrl        String?
  notes           String?
  status          PaymentRequestStatus @default(PENDING_CONFIRMATION)
  submittedAt     DateTime             @default(now())
  submittedByUserId String?
  submittedBy     User?                @relation("PaymentRequestSubmitter", fields: [submittedByUserId], references: [id])
  reviewedAt      DateTime?
  reviewedByUserId String?
  reviewedBy      User?                @relation("PaymentRequestReviewer", fields: [reviewedByUserId], references: [id])
  rejectionReason String?
  receiptVoucherId String?             @unique
  receiptVoucher  ReceiptVoucher?      @relation("PaymentRequestReceipt")
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([invoiceId])
  @@index([customerId])
  @@index([status])
}

model ReceiptVoucher {
  id                    String          @id @default(uuid())
  receiptNumber         String          @unique
  invoiceId             String
  invoice               Invoice         @relation(fields: [invoiceId], references: [id])
  customerId            String
  customer              Customer        @relation(fields: [customerId], references: [id])
  paymentRequestId      String?         @unique
  paymentRequest        PaymentRequest? @relation("PaymentRequestReceipt", fields: [paymentRequestId], references: [id])
  amount                Float
  amountSAR             Float
  currency              String          @default("SAR")
  fxRateToSAR           Float           @default(1)
  paymentMethod         String
  referenceNumber       String?
  pdfUrl                String?
  confirmedByUserId     String?
  confirmedBy           User?           @relation("ReceiptConfirmer", fields: [confirmedByUserId], references: [id])
  confirmedAt           DateTime        @default(now())
  payments              Payment[]
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([invoiceId])
  @@index([customerId])
}

model ExchangeRate {
  id            String   @id @default(uuid())
  date          DateTime @db.Date
  fromCurrency  String
  toCurrency    String   @default("SAR")
  rate          Float
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([date, fromCurrency, toCurrency])
  @@index([fromCurrency, toCurrency])
}

model UserPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferredCurrencyCode String   @default("SAR")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ==================== TIME STANDARDS ====================

model TimeStandard {
  id              String    @id @default(uuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id])
  processType     String
  doseForm        String?
  standardMinutes Int
  description     String?
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([productId, processType])
  @@index([effectiveFrom, effectiveTo])
}

// ==================== SYSTEM SETTINGS ====================

model SettingCountry {
  id          String          @id @default(uuid())
  code        String          @unique
  name        String
  nameAr      String?
  isActive    Boolean         @default(true)
  cities      SettingCity[]
  regions     SettingRegion[]
  customers   Customer[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model SettingCity {
  id          String          @id @default(uuid())
  countryId   String
  country     SettingCountry  @relation(fields: [countryId], references: [id])
  regionId    String?
  region      SettingRegion?  @relation(fields: [regionId], references: [id])
  code        String
  name        String
  nameAr      String?
  isActive    Boolean         @default(true)
  customers   Customer[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([countryId, code])
}

model SettingRegion {
  id          String          @id @default(uuid())
  countryId   String
  country     SettingCountry  @relation(fields: [countryId], references: [id])
  code        String
  name        String
  nameAr      String?
  isActive    Boolean         @default(true)
  customers   Customer[]
  cities      SettingCity[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([countryId, code])
}

model SettingCategory {
  id          String     @id @default(uuid())
  code        String     @unique
  name        String
  nameAr      String?
  description String?
  isActive    Boolean    @default(true)
  customers   Customer[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model SettingCourier {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  vehicles    SettingVehicle[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingVehicle {
  id            String          @id @default(uuid())
  courierId     String?
  courier       SettingCourier? @relation(fields: [courierId], references: [id])
  plateNumber   String          @unique
  vehicleType   String
  model         String?
  capacity      String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model SettingDoseUnit {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  symbol      String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingProductType {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingProductionMethod {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingCurrency {
  id            String   @id @default(uuid())
  code          String   @unique
  name          String
  nameAr        String?
  symbol        String
  exchangeRate  Float    @default(1.0)
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ==================== ATTACHMENT SYSTEM ====================

model AttachmentType {
  id          String   @id @default(uuid())
  name        String
  extensions  String[]
  mimeTypes   String[]
  maxSizeMB   Float    @default(5.0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  attachments Attachment[]
}

model Attachment {
  id              String         @id @default(uuid())
  fileName        String
  originalName    String
  mimeType        String
  fileSize        Int
  filePath        String
  description     String?
  
  entityType      String
  entityId        String
  
  attachmentTypeId String?
  attachmentType   AttachmentType? @relation(fields: [attachmentTypeId], references: [id])
  
  uploadedById    String
  uploadedBy      User           @relation(fields: [uploadedById], references: [id])
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([entityType, entityId])
}

// ==================== PROCUREMENT & SUPPLY CHAIN ====================

enum SupplierStatus {
  ACTIVE
  ON_HOLD
  BLOCKED
}

model Supplier {
  id              String         @id @default(uuid())
  code            String         @unique
  name            String
  nameAr          String?
  email           String?
  phone           String?
  mobile          String?
  website         String?
  
  // Tax & Financial
  taxNumber       String?
  vatNumber       String?
  crNumber        String?        // Commercial Registration
  
  // Bank Information
  bankName        String?
  bankBranch      String?
  bankAccountName String?
  bankAccountNumber String?
  bankIban        String?
  bankSwift       String?
  
  // Address
  address         String?
  city            String?
  region          String?
  country         String?
  postalCode      String?
  
  // Terms
  paymentTermsDays Int           @default(30)
  currencyCode    String         @default("SAR")
  
  status          SupplierStatus @default(ACTIVE)
  notes           String?
  
  contacts        SupplierContact[]
  documents       SupplierDocument[]
  rfqQuotes       RFQQuote[]
  purchaseOrders  PurchaseOrder[]
  grns            GoodsReceivedNote[]
  invoices        SupplierInvoice[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model SupplierContact {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  name        String
  title       String?
  email       String?
  phone       String?
  mobile      String?
  isPrimary   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum SupplierDocType {
  CONTRACT
  LICENSE
  CERTIFICATE
  TAX_CERT
  INSURANCE
  QUALITY_CERT
  OTHER
}

model SupplierDocument {
  id          String          @id @default(uuid())
  supplierId  String
  supplier    Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  docType     SupplierDocType
  docName     String
  fileName    String
  filePath    String
  mimeType    String
  fileSizeBytes Int
  expiryDate  DateTime?
  notes       String?
  uploadedById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Request for Quotation
enum RFQStatus {
  DRAFT
  SENT
  QUOTES_RECEIVED
  EVALUATED
  APPROVED
  CANCELLED
  EXPIRED
}

model RFQ {
  id              String     @id @default(uuid())
  rfqNumber       String     @unique
  title           String
  description     String?
  
  requiredByDate  DateTime?
  validUntilDate  DateTime?
  
  status          RFQStatus  @default(DRAFT)
  
  // Source info (optional)
  sourceType      String?    // MANUAL, PRODUCTION_DEMAND, REORDER
  sourceId        String?
  
  notes           String?
  
  items           RFQItem[]
  quotes          RFQQuote[]
  selectedQuoteId String?
  
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model RFQItem {
  id              String   @id @default(uuid())
  rfqId           String
  rfq             RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  
  itemCode        String
  itemName        String
  description     String?
  quantity        Float
  unit            String   @default("EA")
  
  specifications  String?
  
  quoteItems      RFQQuoteItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model RFQQuote {
  id              String   @id @default(uuid())
  rfqId           String
  rfq             RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  quoteNumber     String?
  quoteDate       DateTime @default(now())
  validUntilDate  DateTime?
  leadTimeDays    Int?
  
  totalAmount     Decimal  @db.Decimal(12, 2)
  currencyCode    String   @default("SAR")
  
  paymentTerms    String?
  deliveryTerms   String?
  notes           String?
  
  isSelected      Boolean  @default(false)
  
  items           RFQQuoteItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([rfqId, supplierId])
}

model RFQQuoteItem {
  id              String      @id @default(uuid())
  quoteId         String
  quote           RFQQuote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  rfqItemId       String
  rfqItem         RFQItem     @relation(fields: [rfqItemId], references: [id])
  
  unitPrice       Decimal     @db.Decimal(12, 4)
  quantity        Float
  totalPrice      Decimal     @db.Decimal(12, 2)
  
  leadTimeDays    Int?
  notes           String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Purchase Orders
enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  ACKNOWLEDGED
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
  CANCELLED
}

model PurchaseOrder {
  id              String     @id @default(uuid())
  poNumber        String     @unique
  supplierId      String
  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  
  // Source (optional - from RFQ)
  rfqId           String?
  quoteId         String?
  
  orderDate       DateTime   @default(now())
  expectedDate    DateTime?
  
  status          POStatus   @default(DRAFT)
  
  // Amounts
  subtotal        Decimal    @db.Decimal(12, 2)
  taxAmount       Decimal    @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal    @db.Decimal(12, 2)
  currencyCode    String     @default("SAR")
  
  paymentTermsDays Int       @default(30)
  deliveryTerms   String?
  shippingAddress String?
  
  notes           String?
  
  items           PurchaseOrderItem[]
  grns            GoodsReceivedNote[]
  invoices        SupplierInvoice[]
  threeWayMatches ThreeWayMatch[]
  
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  sentAt          DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model PurchaseOrderItem {
  id              String         @id @default(uuid())
  poId            String
  purchaseOrder   PurchaseOrder  @relation(fields: [poId], references: [id], onDelete: Cascade)
  
  lineNumber      Int
  itemCode        String
  itemName        String
  description     String?
  
  orderedQty      Float
  receivedQty     Float          @default(0)
  unit            String         @default("EA")
  
  unitPrice       Decimal        @db.Decimal(12, 4)
  totalPrice      Decimal        @db.Decimal(12, 2)
  
  grnItems        GRNItem[]
  invoiceItems    SupplierInvoiceItem[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// Goods Received Note (Receiving)
enum GRNStatus {
  DRAFT
  PENDING_QC
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
}

model GoodsReceivedNote {
  id              String     @id @default(uuid())
  grnNumber       String     @unique
  
  poId            String
  purchaseOrder   PurchaseOrder @relation(fields: [poId], references: [id])
  supplierId      String
  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  
  receivedDate    DateTime   @default(now())
  deliveryNoteNumber String?
  
  status          GRNStatus  @default(DRAFT)
  
  notes           String?
  
  items           GRNItem[]
  threeWayMatches ThreeWayMatch[]
  
  receivedById    String
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

enum GRNItemStatus {
  QUARANTINE
  RELEASED
  REJECTED
}

model GRNItem {
  id              String     @id @default(uuid())
  grnId           String
  grn             GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItemId        String
  poItem          PurchaseOrderItem @relation(fields: [poItemId], references: [id])
  
  receivedQty     Float
  acceptedQty     Float      @default(0)
  rejectedQty     Float      @default(0)
  unit            String     @default("EA")
  
  // Lot tracking
  lotNumber       String?
  batchNumber     String?
  expiryDate      DateTime?
  manufacturingDate DateTime?
  
  // Storage location
  warehouseId     String?
  binLocation     String?
  
  status          GRNItemStatus @default(QUARANTINE)
  
  notes           String?
  rejectionReason String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// Supplier Invoices
enum SupplierInvoiceStatus {
  DRAFT
  PENDING_MATCH
  MATCHED
  DISCREPANCY
  PENDING_APPROVAL
  APPROVED
  POSTED
  PAID
  CANCELLED
}

model SupplierInvoice {
  id              String     @id @default(uuid())
  invoiceNumber   String     @unique
  supplierInvoiceNumber String?
  
  supplierId      String
  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  poId            String?
  purchaseOrder   PurchaseOrder? @relation(fields: [poId], references: [id])
  
  invoiceDate     DateTime
  dueDate         DateTime?
  
  status          SupplierInvoiceStatus @default(DRAFT)
  
  // Amounts
  subtotal        Decimal    @db.Decimal(12, 2)
  taxAmount       Decimal    @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal    @db.Decimal(12, 2)
  paidAmount      Decimal    @db.Decimal(12, 2) @default(0)
  currencyCode    String     @default("SAR")
  
  notes           String?
  
  items           SupplierInvoiceItem[]
  threeWayMatches ThreeWayMatch[]
  
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  postedAt        DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model SupplierInvoiceItem {
  id              String          @id @default(uuid())
  invoiceId       String
  invoice         SupplierInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  poItemId        String?
  poItem          PurchaseOrderItem? @relation(fields: [poItemId], references: [id])
  
  lineNumber      Int
  itemCode        String
  itemName        String
  description     String?
  
  quantity        Float
  unit            String          @default("EA")
  unitPrice       Decimal         @db.Decimal(12, 4)
  totalPrice      Decimal         @db.Decimal(12, 2)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// 3-Way Match
enum MatchStatus {
  PENDING
  MATCHED
  DISCREPANCY
  APPROVED_WITH_OVERRIDE
  REJECTED
}

model ThreeWayMatch {
  id              String          @id @default(uuid())
  matchNumber     String          @unique
  
  poId            String
  purchaseOrder   PurchaseOrder   @relation(fields: [poId], references: [id])
  grnId           String
  grn             GoodsReceivedNote @relation(fields: [grnId], references: [id])
  invoiceId       String
  invoice         SupplierInvoice @relation(fields: [invoiceId], references: [id])
  
  status          MatchStatus     @default(PENDING)
  
  // Variance tracking
  qtyVariance     Float           @default(0)
  priceVariance   Decimal         @db.Decimal(12, 2) @default(0)
  
  // Override approval (when discrepancy approved)
  overrideReason  String?
  overrideById    String?
  overrideAt      DateTime?
  
  matchedById     String?
  matchedAt       DateTime?
  
  notes           String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}
