generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AUTHENTICATION & RBAC ====================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  isActive      Boolean   @default(true)
  roleId        String
  role          Role      @relation(fields: [roleId], references: [id])
  customerId    String?
  customer      Customer? @relation(fields: [customerId], references: [id])
  driver        Driver?
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  notifications Notification[]
  batchOperators BatchOperator[]
  qcResults     QCResult[]
  batchReleases BatchRelease[]
  approvalRequests ApprovalRequest[] @relation("ApprovalRequester")
  approvalActions  ApprovalAction[]  @relation("ApprovalActor")
  dispensedDoses   DoseUnit[]        @relation("DoseDispenser")
  orderHistories   OrderHistory[]
  batchEvents      BatchEvent[]
  uploadedDocuments CustomerDocument[]
  uploadedLocationPhotos CustomerLocationPhoto[] @relation("LocationPhotoUploader")
  submittedPaymentRequests PaymentRequest[] @relation("PaymentRequestSubmitter")
  reviewedPaymentRequests  PaymentRequest[] @relation("PaymentRequestReviewer")
  confirmedReceipts        ReceiptVoucher[] @relation("ReceiptConfirmer")
  approvedInvoices         Invoice[]        @relation("InvoiceApprover")
  invoiceEvents            InvoiceEvent[]   @relation("InvoiceEventUser")
  eSignatures              ESignature[]
  samplesTaken             Sample[]         @relation("SampleTaker")
  testResults              TestResult[]     @relation("TestAnalyst")
  oosOpened                OOSCase[]        @relation("OOSOpener")
  oosClosed                OOSCase[]        @relation("OOSCloser")
  oosPhase1Investigations  OOSCase[]        @relation("OOSPhase1Investigator")
  oosPhase2Lead            OOSCase[]        @relation("OOSPhase2Lead")
  oosCAPAProposed          OOSCase[]        @relation("OOSCAPAProposer")
  oosCAPAApproved          OOSCase[]        @relation("OOSCAPAApprover")
  preference               UserPreference?
  attachments              Attachment[]
  recipesCreated           Recipe[]         @relation("RecipeCreatedBy")
  recipesActivated         Recipe[]         @relation("RecipeActivatedBy")
  posCreated               PurchaseOrder[]  @relation("POCreator")
  posApproved              PurchaseOrder[]  @relation("POApprover")
  
  batchRecordsStarted      BatchRecord[]    @relation("BatchRecordStartedBy")
  batchRecordsCompleted    BatchRecord[]    @relation("BatchRecordCompletedBy")
  batchRecordsReviewed     BatchRecord[]    @relation("BatchRecordReviewedBy")
  batchRecordsApproved     BatchRecord[]    @relation("BatchRecordApprovedBy")
  stepsExecuted            BatchRecordStep[] @relation("StepExecutedBy")
  stepsVerified            BatchRecordStep[] @relation("StepVerifiedBy")
  materialConsumptions     BatchMaterialConsumption[]
  batchEquipmentUsages     BatchEquipmentUsage[]
  deviationsReported       BatchDeviation[] @relation("DeviationReportedBy")
  deviationsAssigned       BatchDeviation[] @relation("DeviationAssignedTo")
  deviationsApproved       BatchDeviation[] @relation("DeviationApprovedBy")
  deviationsClosed         BatchDeviation[] @relation("DeviationClosedBy")
  
  notificationChannelUpdates NotificationChannelConfig[] @relation("NotificationChannelUpdatedBy")
  notificationPreference     UserNotificationPreference? @relation("UserNotificationPreference")
  
  announcementsCreated       Announcement[]              @relation("AnnouncementCreatedBy")
  announcementAudiences      AnnouncementAudience[]      @relation("AnnouncementAudienceUser")
  announcementDeliveries     AnnouncementDelivery[]      @relation("AnnouncementDeliveryUser")
  
  qcSessionsAsAnalyst        BatchQcSession[]            @relation("QcSessionAnalyst")
  qcSessionsAsReviewer       BatchQcSession[]            @relation("QcSessionReviewer")
  qcResultsEntered           BatchQcResult[]             @relation("QcResultEnteredBy")
  qcAttachmentsUploaded      BatchQcAttachment[]         @relation("QcAttachmentUploader")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Role {
  id            String         @id @default(uuid())
  name          String         @unique
  description   String?
  permissions   Permission[]
  users         User[]
  approvalSteps ApprovalStep[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Permission {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  roles       Role[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// ==================== CUSTOMER & COMPLIANCE ====================

model Customer {
  id                  String    @id @default(uuid())
  code                String    @unique
  name                String
  nameEn              String?
  nameAr              String?
  email               String?
  mobile              String?
  phone               String?
  
  crNumber            String?
  taxNumber           String?
  
  fullAddress         String?
  shortAddress        String?
  buildingNo          String?
  street              String?
  secondaryNo         String?
  district            String?
  postalCode          String?
  cityId              String?
  city                SettingCity?   @relation(fields: [cityId], references: [id])
  regionId            String?
  region              SettingRegion? @relation(fields: [regionId], references: [id])
  countryId           String?
  country             SettingCountry? @relation(fields: [countryId], references: [id])
  address             String?
  
  latitude            Decimal?  @db.Decimal(9, 6)
  longitude           Decimal?  @db.Decimal(9, 6)
  
  logoUrl             String?
  
  licenseNumber       String?
  licenseExpiryDate   DateTime?
  deliveryWindowStart String?
  deliveryWindowEnd   String?
  preferredDeliveryTime String?
  travelTimeMinutes   Int       @default(60)
  categoryId          String?
  category            SettingCategory? @relation(fields: [categoryId], references: [id])
  isActive            Boolean   @default(true)
  
  permittedProducts   CustomerProduct[]
  contacts            CustomerContact[]
  documents           CustomerDocument[]
  locationPhotos      CustomerLocationPhoto[]
  orders              Order[]
  users               User[]
  shipments           Shipment[]
  reservations        Reservation[]
  contracts           Contract[]
  invoices            Invoice[]
  paymentRequests     PaymentRequest[]
  receiptVouchers     ReceiptVoucher[]
  announcementAudiences AnnouncementAudience[]
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
}

enum DocumentType {
  CR
  TAX_CERT
  LICENSE
  CONTRACT
  NDA
  OTHER
}

model CustomerDocument {
  id              String       @id @default(uuid())
  customerId      String
  customer        Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  docType         DocumentType
  docName         String
  fileUrl         String
  fileSizeBytes   Int
  mimeType        String
  uploadedByUserId String?
  uploadedBy      User?        @relation(fields: [uploadedByUserId], references: [id])
  uploadedAt      DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model CustomerLocationPhoto {
  id              String    @id @default(uuid())
  customerId      String
  customer        Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  photoUrl        String
  caption         String?
  fileSizeBytes   Int
  mimeType        String
  uploadedByUserId String?
  uploadedBy      User?     @relation("LocationPhotoUploader", fields: [uploadedByUserId], references: [id])
  uploadedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model CustomerContact {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  name       String
  title      String?
  email      String
  phone      String?
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CustomerProduct {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  isApproved Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([customerId, productId])
}

// ==================== PRODUCT CATALOG ====================

enum ProductType {
  PET
  SPECT
  THERAPY
}

enum ProductionMethod {
  CYCLOTRON
  GENERATOR
  KIT
}

model Product {
  id                    String           @id @default(uuid())
  name                  String
  code                  String           @unique
  productType           ProductType
  radionuclide          String
  halfLifeMinutes       Float
  shelfLifeMinutes      Float
  minConcentration      Float?
  maxConcentration      Float?
  standardDose          Float?
  doseUnit              String           @default("mCi")
  productionMethod      ProductionMethod
  synthesisTimeMinutes  Int              @default(60)
  qcTimeMinutes         Int              @default(30)
  packagingTimeMinutes  Int              @default(15)
  packagingType         String?
  transportConstraints  String?
  calibrationTimeOffset Int              @default(0)
  overagePercent        Float            @default(10)
  isActive              Boolean          @default(true)
  qcTemplates           QCTemplate[]
  productQcTemplates    ProductQcTemplate[]  @relation("ProductQcTemplates")
  customerProducts      CustomerProduct[]
  orders                Order[]
  batches               Batch[]
  reservations          Reservation[]
  contractPriceItems    ContractPriceItem[]
  invoiceItems          InvoiceItem[]
  timeStandards         TimeStandard[]
  testSpecs             TestSpec[]
  recipes               Recipe[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
}

model QCTemplate {
  id                String     @id @default(uuid())
  productId         String
  product           Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  testName          String
  testMethod        String?
  acceptanceCriteria String
  minValue          Float?
  maxValue          Float?
  unit              String?
  isRequired        Boolean    @default(true)
  sortOrder         Int        @default(0)
  qcResults         QCResult[]
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
}

// ==================== ORDERING ====================

enum OrderStatus {
  DRAFT
  SUBMITTED
  VALIDATED
  SCHEDULED
  IN_PRODUCTION
  QC_PENDING
  RELEASED
  DISPATCHED
  DELIVERED
  CANCELLED
  REJECTED
  FAILED_QC
  REWORK
}

model Order {
  id                    String      @id @default(uuid())
  orderNumber           String      @unique
  customerId            String
  customer              Customer    @relation(fields: [customerId], references: [id])
  productId             String
  product               Product     @relation(fields: [productId], references: [id])
  deliveryDate          DateTime
  deliveryTimeStart     DateTime
  deliveryTimeEnd       DateTime
  requestedActivity     Float
  activityUnit          String      @default("mCi")
  numberOfDoses         Int?
  injectionTime         DateTime?
  patientCount          Int?
  specialNotes          String?
  hospitalOrderReference String?
  committedDispensingMinutes Int?
  calculatedProductionActivity Float?
  calculatedCalibrationTime    DateTime?
  status                OrderStatus @default(DRAFT)
  version               Int         @default(1)
  batchId               String?
  batch                 Batch?      @relation(fields: [batchId], references: [id])
  shipmentId            String?
  shipment              Shipment?   @relation(fields: [shipmentId], references: [id])
  reservationId         String?
  reservation           Reservation? @relation(fields: [reservationId], references: [id])
  orderHistory          OrderHistory[]
  doseUnits             DoseUnit[]
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
}

model OrderHistory {
  id          String       @id @default(uuid())
  orderId     String
  order       Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  fromStatus  OrderStatus?
  toStatus    OrderStatus
  changedBy   String?
  changedByUser User?      @relation(fields: [changedBy], references: [id])
  role        String?
  changeNotes String?
  metadata    Json?
  snapshot    Json?
  createdAt   DateTime     @default(now())

  @@index([orderId])
}

// ==================== BATCH & LOT MANAGEMENT ====================

enum BatchStatus {
  PLANNED
  SCHEDULED
  IN_PRODUCTION
  PRODUCTION_COMPLETE
  QC_PENDING
  QC_IN_PROGRESS
  QC_PASSED
  QP_REVIEW
  RELEASED
  DISPENSING_IN_PROGRESS
  DISPENSED
  PACKED
  DISPATCHED
  CLOSED
  ON_HOLD
  REJECTED
  FAILED_QC
  CANCELLED
  DEVIATION_OPEN
}

model BatchEvent {
  id          String      @id @default(uuid())
  batchId     String
  batch       Batch       @relation(fields: [batchId], references: [id], onDelete: Cascade)
  eventType   String      @default("STATUS_CHANGE")
  fromStatus  BatchStatus?
  toStatus    BatchStatus?
  actorId     String?
  actor       User?       @relation(fields: [actorId], references: [id])
  actorRole   String?
  note        String?
  metadata    Json?
  traceId     String?
  createdAt   DateTime    @default(now())

  @@index([batchId])
  @@index([createdAt])
}

model Batch {
  id                  String        @id @default(uuid())
  batchNumber         String        @unique
  productId           String
  product             Product       @relation(fields: [productId], references: [id])
  plannedStartTime    DateTime
  plannedEndTime      DateTime
  actualStartTime     DateTime?
  actualEndTime       DateTime?
  targetActivity      Float
  actualActivity      Float?
  activityUnit        String        @default("mCi")
  calibrationTime     DateTime?
  synthesisModuleId   String?
  synthesisModule     Equipment?    @relation("SynthesisModule", fields: [synthesisModuleId], references: [id])
  hotCellId           String?
  hotCell             Equipment?    @relation("HotCell", fields: [hotCellId], references: [id])
  status              BatchStatus   @default(PLANNED)
  notes               String?
  recipeId            String?
  recipe              Recipe?       @relation("BatchRecipe", fields: [recipeId], references: [id])
  orders              Order[]
  operators           BatchOperator[]
  materialLots        BatchMaterialLot[]
  qcResults           QCResult[]
  batchQcSession      BatchQcSession?  @relation("BatchQcSession")
  batchReleases       BatchRelease[]
  doseUnits           DoseUnit[]
  events              BatchEvent[]
  samples             Sample[]
  oosCases            OOSCase[]
  batchRecord         BatchRecord?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
}

model BatchOperator {
  id        String   @id @default(uuid())
  batchId   String
  batch     Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      String?
  startTime DateTime?
  endTime   DateTime?
  createdAt DateTime @default(now())

  @@unique([batchId, userId])
}

// ==================== eBR (Electronic Batch Record) MODULE ====================

enum BatchRecordStatus {
  DRAFT
  IN_PROGRESS
  PENDING_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum StepExecutionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  FAILED
  ON_HOLD
}

enum DeviationType {
  PROCESS
  EQUIPMENT
  MATERIAL
  ENVIRONMENT
  PERSONNEL
  DOCUMENTATION
  OTHER
}

enum DeviationSeverity {
  MINOR
  MAJOR
  CRITICAL
}

enum DeviationStatus {
  OPEN
  UNDER_INVESTIGATION
  PENDING_APPROVAL
  APPROVED
  REJECTED
  CLOSED
}

model BatchRecord {
  id                    String            @id @default(uuid())
  batchId               String            @unique
  batch                 Batch             @relation(fields: [batchId], references: [id], onDelete: Cascade)
  recipeId              String
  recipe                Recipe            @relation(fields: [recipeId], references: [id])
  recipeVersion         Int
  status                BatchRecordStatus @default(DRAFT)
  
  plannedYield          Float
  actualYield           Float?
  yieldUnit             String
  yieldVariance         Float?
  
  startedAt             DateTime?
  completedAt           DateTime?
  reviewedAt            DateTime?
  approvedAt            DateTime?
  
  startedById           String?
  startedBy             User?             @relation("BatchRecordStartedBy", fields: [startedById], references: [id])
  completedById         String?
  completedBy           User?             @relation("BatchRecordCompletedBy", fields: [completedById], references: [id])
  reviewedById          String?
  reviewedBy            User?             @relation("BatchRecordReviewedBy", fields: [reviewedById], references: [id])
  approvedById          String?
  approvedBy            User?             @relation("BatchRecordApprovedBy", fields: [approvedById], references: [id])
  
  approvalSignatureId   String?
  approvalSignature     ESignature?       @relation(fields: [approvalSignatureId], references: [id])
  
  remarks               String?
  
  steps                 BatchRecordStep[]
  materialConsumptions  BatchMaterialConsumption[]
  equipmentUsages       BatchEquipmentUsage[]
  deviations            BatchDeviation[]
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([batchId])
  @@index([status])
}

model BatchRecordStep {
  id                    String              @id @default(uuid())
  batchRecordId         String
  batchRecord           BatchRecord         @relation(fields: [batchRecordId], references: [id], onDelete: Cascade)
  recipeStepId          String?
  
  stepNumber            Int
  title                 String
  description           String
  instructions          String?
  
  status                StepExecutionStatus @default(PENDING)
  
  plannedDuration       Int?
  actualDuration        Int?
  
  startedAt             DateTime?
  completedAt           DateTime?
  
  executedById          String?
  executedBy            User?               @relation("StepExecutedBy", fields: [executedById], references: [id])
  verifiedById          String?
  verifiedBy            User?               @relation("StepVerifiedBy", fields: [verifiedById], references: [id])
  
  isQualityCheckpoint   Boolean             @default(false)
  checkpointCriteria    String?
  checkpointPassed      Boolean?
  checkpointNotes       String?
  
  targetTemperature     String?
  actualTemperature     String?
  targetPressure        String?
  actualPressure        String?
  
  equipmentUsed         String?
  observations          String?
  remarks               String?
  
  signatureId           String?
  signature             ESignature?         @relation(fields: [signatureId], references: [id])
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@unique([batchRecordId, stepNumber])
  @@index([batchRecordId])
  @@index([status])
}

model BatchMaterialConsumption {
  id                    String            @id @default(uuid())
  batchRecordId         String
  batchRecord           BatchRecord       @relation(fields: [batchRecordId], references: [id], onDelete: Cascade)
  
  materialId            String
  material              Material          @relation(fields: [materialId], references: [id])
  stockItemId           String?
  stockItem             StockItem?        @relation(fields: [stockItemId], references: [id])
  stockMovementId       String?
  stockMovement         StockMovement?    @relation(fields: [stockMovementId], references: [id])
  
  recipeComponentId     String?
  
  plannedQuantity       Float
  actualQuantity        Float?
  unit                  String
  variance              Float?
  variancePercent       Float?
  
  lotNumber             String?
  expiryDate            DateTime?
  
  consumedAt            DateTime?
  consumedById          String?
  consumedBy            User?             @relation(fields: [consumedById], references: [id])
  
  issuedFromWarehouseId String?
  issuedFromWarehouse   Warehouse?        @relation(fields: [issuedFromWarehouseId], references: [id])
  
  notes                 String?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([batchRecordId])
  @@index([materialId])
}

model BatchEquipmentUsage {
  id                    String            @id @default(uuid())
  batchRecordId         String
  batchRecord           BatchRecord       @relation(fields: [batchRecordId], references: [id], onDelete: Cascade)
  equipmentId           String
  equipment             Equipment         @relation(fields: [equipmentId], references: [id])
  
  usageType             String            @default("PRODUCTION")
  
  startTime             DateTime?
  endTime               DateTime?
  durationMinutes       Int?
  
  operatorId            String?
  operator              User?             @relation(fields: [operatorId], references: [id])
  
  preUseCheckPassed     Boolean?
  postUseCheckPassed    Boolean?
  cleaningVerified      Boolean?
  
  settings              Json?
  readings              Json?
  
  notes                 String?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([batchRecordId])
  @@index([equipmentId])
}

model BatchDeviation {
  id                    String            @id @default(uuid())
  deviationNumber       String            @unique
  batchRecordId         String?
  batchRecord           BatchRecord?      @relation(fields: [batchRecordId], references: [id])
  batchId               String?
  
  type                  DeviationType
  severity              DeviationSeverity
  status                DeviationStatus   @default(OPEN)
  
  title                 String
  description           String
  rootCause             String?
  impact                String?
  
  occurredAt            DateTime
  detectedAt            DateTime          @default(now())
  
  reportedById          String
  reportedBy            User              @relation("DeviationReportedBy", fields: [reportedById], references: [id])
  
  assignedToId          String?
  assignedTo            User?             @relation("DeviationAssignedTo", fields: [assignedToId], references: [id])
  
  investigationNotes    String?
  correctiveAction      String?
  preventiveAction      String?
  
  approvedById          String?
  approvedBy            User?             @relation("DeviationApprovedBy", fields: [approvedById], references: [id])
  approvedAt            DateTime?
  approvalSignatureId   String?
  approvalSignature     ESignature?       @relation(fields: [approvalSignatureId], references: [id])
  
  closedById            String?
  closedBy              User?             @relation("DeviationClosedBy", fields: [closedById], references: [id])
  closedAt              DateTime?
  closureNotes          String?
  
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([batchRecordId])
  @@index([status])
  @@index([severity])
}

model Equipment {
  id                String   @id @default(uuid())
  name              String
  code              String   @unique
  type              String
  location          String?
  isAvailable       Boolean  @default(true)
  maintenanceNotes  String?
  synthesisBatches  Batch[]  @relation("SynthesisModule")
  hotCellBatches    Batch[]  @relation("HotCell")
  resourceCalendars ResourceCalendar[]
  batchEquipmentUsages BatchEquipmentUsage[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model MaterialLot {
  id            String   @id @default(uuid())
  materialName  String
  materialCode  String
  lotNumber     String
  expiryDate    DateTime
  quantity      Float
  unit          String
  supplierId    String?
  isActive      Boolean  @default(true)
  batchMaterialLots BatchMaterialLot[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([materialCode, lotNumber])
}

model BatchMaterialLot {
  id            String      @id @default(uuid())
  batchId       String
  batch         Batch       @relation(fields: [batchId], references: [id], onDelete: Cascade)
  materialLotId String
  materialLot   MaterialLot @relation(fields: [materialLotId], references: [id])
  quantityUsed  Float
  createdAt     DateTime    @default(now())

  @@unique([batchId, materialLotId])
}

// ==================== MATERIAL MASTER DATA ====================

enum MaterialCategory {
  RAW_MATERIAL
  CONSUMABLE
  REAGENT
  PACKAGING
  RADIOISOTOPE
  TARGET_MATERIAL
  SOLVENT
  BUFFER
  FILTER
  CONTAINER
  EXCIPIENT
  REFERENCE_STANDARD
}

enum MaterialStatus {
  ACTIVE
  INACTIVE
  DISCONTINUED
  PENDING_APPROVAL
}

model Material {
  id                    String           @id @default(uuid())
  code                  String           @unique
  name                  String
  nameAr                String?
  description           String?
  category              MaterialCategory
  unit                  String
  minStockLevel         Float            @default(0)
  reorderPoint          Float            @default(0)
  reorderQuantity       Float            @default(0)
  leadTimeDays          Int              @default(7)
  shelfLifeDays         Int?
  storageConditions     String?
  handlingInstructions  String?
  hazardClass           String?
  casNumber             String?
  supplierId            String?
  supplier              Supplier?        @relation(fields: [supplierId], references: [id])
  preferredSupplierId   String?
  unitCost              Float?
  currency              String           @default("SAR")
  status                MaterialStatus   @default(ACTIVE)
  requiresQC            Boolean          @default(false)
  isRadioactive         Boolean          @default(false)
  halfLifeMinutes       Float?
  recipeComponents      RecipeComponent[]
  stockItems            StockItem[]
  batchMaterialConsumptions BatchMaterialConsumption[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
}

// ==================== RECIPE/BOM MANAGEMENT ====================

enum RecipeStatus {
  DRAFT
  PENDING_APPROVAL
  ACTIVE
  SUPERSEDED
  OBSOLETE
}

model Recipe {
  id                    String           @id @default(uuid())
  code                  String
  name                  String
  productId             String
  product               Product          @relation(fields: [productId], references: [id])
  version               Int              @default(1)
  status                RecipeStatus     @default(DRAFT)
  effectiveDate         DateTime?
  expiryDate            DateTime?
  description           String?
  yieldQuantity         Float
  yieldUnit             String
  yieldTolerance        Float            @default(5)
  synthesisTimeMinutes  Int?
  totalTimeMinutes      Int?
  specialInstructions   String?
  safetyPrecautions     String?
  equipmentRequirements String?
  qualityNotes          String?
  activatedById         String?
  activatedBy           User?            @relation("RecipeActivatedBy", fields: [activatedById], references: [id])
  activatedAt           DateTime?
  activationSignatureId String?
  supersededById        String?
  supersededBy          Recipe?          @relation("RecipeSupersession", fields: [supersededById], references: [id])
  supersedes            Recipe[]         @relation("RecipeSupersession")
  components            RecipeComponent[]
  steps                 RecipeStep[]
  batches               Batch[]          @relation("BatchRecipe")
  batchRecords          BatchRecord[]
  createdById           String?
  createdBy             User?            @relation("RecipeCreatedBy", fields: [createdById], references: [id])
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([code, version])
  @@index([productId])
  @@index([status])
}

model RecipeComponent {
  id                String   @id @default(uuid())
  recipeId          String
  recipe            Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  materialId        String
  material          Material @relation(fields: [materialId], references: [id])
  sequence          Int      @default(1)
  quantity          Float
  unit              String
  tolerancePercent  Float    @default(5)
  isOptional        Boolean  @default(false)
  isCritical        Boolean  @default(false)
  additionNotes     String?
  processingNotes   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([recipeId, materialId])
  @@index([recipeId])
}

model RecipeStep {
  id                String   @id @default(uuid())
  recipeId          String
  recipe            Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  stepNumber        Int
  title             String
  description       String
  durationMinutes   Int?
  temperature       String?
  pressure          String?
  equipmentRequired String?
  safetyNotes       String?
  qualityCheckpoint Boolean  @default(false)
  checkpointCriteria String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([recipeId, stepNumber])
  @@index([recipeId])
}

// ==================== QC MODULE ====================

enum QCResultStatus {
  PENDING
  IN_PROGRESS
  PASSED
  FAILED
}

model QCResult {
  id            String         @id @default(uuid())
  batchId       String
  batch         Batch          @relation(fields: [batchId], references: [id], onDelete: Cascade)
  templateId    String
  template      QCTemplate     @relation(fields: [templateId], references: [id])
  numericResult Float?
  textResult    String?
  passed        Boolean?
  status        QCResultStatus @default(PENDING)
  testedById    String?
  testedBy      User?          @relation(fields: [testedById], references: [id])
  testedAt      DateTime?
  notes         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

// ==================== QC BATCH TESTING SYSTEM ====================

enum QcTestResultType {
  PASS_FAIL
  NUMERIC
  TEXT
  OPTION_LIST
}

enum QcSpecRuleType {
  MIN
  MAX
  RANGE
  EQUAL
  PASS_FAIL_ONLY
  CUSTOM_TEXT
}

enum QcTemplateStatus {
  DRAFT
  ACTIVE
  RETIRED
}

enum QcSessionStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  QC_PASSED
  QC_FAILED
  WAITING_REVIEW
}

enum QcResultEntryStatus {
  PENDING
  PASS
  FAIL
  NOT_APPLICABLE
}

model QcTestDefinition {
  id              String            @id @default(uuid())
  code            String            @unique
  nameEn          String
  nameAr          String?
  methodEn        String?
  methodAr        String?
  resultType      QcTestResultType
  unit            String?
  decimalPlaces   Int?
  optionsList     String?           // JSON array for OPTION_LIST type
  isActive        Boolean           @default(true)
  templateLines   ProductQcTemplateLine[]
  batchQcResults  BatchQcResult[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model QcSpecRule {
  id              String          @id @default(uuid())
  ruleType        QcSpecRuleType
  minValue        Decimal?        @db.Decimal(18, 6)
  maxValue        Decimal?        @db.Decimal(18, 6)
  targetValue     Decimal?        @db.Decimal(18, 6)
  tolerance       Decimal?        @db.Decimal(18, 6)
  textCriteriaEn  String?
  textCriteriaAr  String?
  failIfOutside   Boolean         @default(true)
  templateLines   ProductQcTemplateLine[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model ProductQcTemplate {
  id              String            @id @default(uuid())
  productId       String
  product         Product           @relation("ProductQcTemplates", fields: [productId], references: [id], onDelete: Cascade)
  version         Int               @default(1)
  status          QcTemplateStatus  @default(DRAFT)
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  notes           String?
  templateLines   ProductQcTemplateLine[]
  batchQcSessions BatchQcSession[]
  createdById     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([productId, version])
}

model ProductQcTemplateLine {
  id                      String            @id @default(uuid())
  templateId              String
  template                ProductQcTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  testDefinitionId        String
  testDefinition          QcTestDefinition  @relation(fields: [testDefinitionId], references: [id])
  displayOrder            Int               @default(0)
  isRequired              Boolean           @default(true)
  specRuleId              String?
  specRule                QcSpecRule?       @relation(fields: [specRuleId], references: [id])
  criteriaTextOverrideEn  String?
  criteriaTextOverrideAr  String?
  defaultResultValue      String?
  allowManualPassFail     Boolean           @default(false)
  attachmentRequired      Boolean           @default(false)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
}

model BatchQcSession {
  id              String            @id @default(uuid())
  batchId         String            @unique
  batch           Batch             @relation("BatchQcSession", fields: [batchId], references: [id], onDelete: Cascade)
  productId       String
  templateId      String
  template        ProductQcTemplate @relation(fields: [templateId], references: [id])
  status          QcSessionStatus   @default(NOT_STARTED)
  startedAt       DateTime?
  completedAt     DateTime?
  analystUserId   String?
  analystUser     User?             @relation("QcSessionAnalyst", fields: [analystUserId], references: [id])
  reviewedByUserId String?
  reviewedByUser  User?             @relation("QcSessionReviewer", fields: [reviewedByUserId], references: [id])
  reviewedAt      DateTime?
  notes           String?
  results         BatchQcResult[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
}

model BatchQcResult {
  id                  String              @id @default(uuid())
  qcSessionId         String
  qcSession           BatchQcSession      @relation(fields: [qcSessionId], references: [id], onDelete: Cascade)
  testDefinitionId    String
  testDefinition      QcTestDefinition    @relation(fields: [testDefinitionId], references: [id])
  displayOrder        Int                 @default(0)
  criteriaDisplayEn   String?
  criteriaDisplayAr   String?
  resultType          QcTestResultType
  numericValue        Decimal?            @db.Decimal(18, 6)
  textValue           String?
  passFailValue       String?             // "PASS" or "FAIL"
  selectedOption      String?             // for OPTION_LIST type
  unit                String?
  status              QcResultEntryStatus @default(PENDING)
  isRequired          Boolean             @default(true)
  specRuleType        QcSpecRuleType?
  specMinValue        Decimal?            @db.Decimal(18, 6)
  specMaxValue        Decimal?            @db.Decimal(18, 6)
  specTargetValue     Decimal?            @db.Decimal(18, 6)
  failReason          String?
  enteredByUserId     String?
  enteredByUser       User?               @relation("QcResultEnteredBy", fields: [enteredByUserId], references: [id])
  enteredAt           DateTime?
  attachments         BatchQcAttachment[]
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
}

model BatchQcAttachment {
  id              String        @id @default(uuid())
  batchQcResultId String
  batchQcResult   BatchQcResult @relation(fields: [batchQcResultId], references: [id], onDelete: Cascade)
  fileUrl         String
  fileName        String
  fileSizeBytes   Int
  mimeType        String
  uploadedByUserId String?
  uploadedByUser  User?         @relation("QcAttachmentUploader", fields: [uploadedByUserId], references: [id])
  uploadedAt      DateTime      @default(now())
  createdAt       DateTime      @default(now())
}

model BatchRelease {
  id               String           @id @default(uuid())
  batchId          String
  batch            Batch            @relation(fields: [batchId], references: [id], onDelete: Cascade)
  releasedById     String
  releasedBy       User             @relation(fields: [releasedById], references: [id])
  releaseType      String           @default("FULL")
  disposition      BatchDisposition @default(RELEASE)
  electronicSignature String
  signatureTimestamp DateTime
  meaning          String?
  reason           String?
  coaFilePath      String?
  createdAt        DateTime         @default(now())
}

enum BatchDisposition {
  HOLD
  RELEASE
  REJECT
}

// ==================== E-SIGNATURE ====================

enum ESignatureScope {
  BATCH_RELEASE
  DEVIATION_APPROVAL
  MASTERDATA_CHANGE
  RECIPE_ACTIVATION
  PO_APPROVAL
  FINANCIAL_APPROVAL
  QC_APPROVAL
  DISPENSING_APPROVAL
}

model ESignature {
  id          String          @id @default(uuid())
  scope       ESignatureScope
  entityType  String
  entityId    String
  signedById  String
  signedBy    User            @relation(fields: [signedById], references: [id])
  signedAt    DateTime        @default(now())
  meaning     String
  comment     String?
  metadata    Json?
  createdAt   DateTime        @default(now())

  batchRecords          BatchRecord[]
  batchRecordSteps      BatchRecordStep[]
  batchDeviations       BatchDeviation[]
  oosCAPAApprovals      OOSCase[]        @relation("OOSCAPAApprovalSignature")
  oosClosures           OOSCase[]        @relation("OOSClosureSignature")

  @@index([entityType, entityId])
  @@index([signedById])
}

// ==================== QMS - SAMPLE & TEST MANAGEMENT ====================

enum SampleStatus {
  COLLECTED
  IN_TESTING
  TESTED
  APPROVED
  REJECTED
}

model Sample {
  id          String       @id @default(uuid())
  sampleNumber String      @unique
  batchId     String
  batch       Batch        @relation(fields: [batchId], references: [id], onDelete: Cascade)
  sampleType  String
  takenAt     DateTime     @default(now())
  takenById   String
  takenBy     User         @relation("SampleTaker", fields: [takenById], references: [id])
  status      SampleStatus @default(COLLECTED)
  notes       String?
  testResults TestResult[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([batchId])
}

model TestSpec {
  id          String       @id @default(uuid())
  productId   String
  product     Product      @relation(fields: [productId], references: [id])
  testName    String
  testMethod  String?
  unit        String?
  minValue    Float?
  maxValue    Float?
  required    Boolean      @default(true)
  sortOrder   Int          @default(0)
  isActive    Boolean      @default(true)
  testResults TestResult[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([productId, testName])
}

model TestResult {
  id          String   @id @default(uuid())
  sampleId    String
  sample      Sample   @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  testSpecId  String
  testSpec    TestSpec @relation(fields: [testSpecId], references: [id])
  numericValue Float?
  textValue   String?
  passFail    Boolean?
  measuredAt  DateTime @default(now())
  analystId   String
  analyst     User     @relation("TestAnalyst", fields: [analystId], references: [id])
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sampleId])
  @@index([testSpecId])
}

enum OOSCaseType {
  OOS              // Out of Specification
  OOT              // Out of Trend
  OOE              // Out of Expectation
}

enum OOSCaseStatus {
  OPEN
  PHASE_1_LAB_INVESTIGATION
  PHASE_1_COMPLETE
  PHASE_2_FULL_INVESTIGATION
  PHASE_2_COMPLETE
  CAPA_PROPOSED
  CAPA_APPROVED
  CAPA_IMPLEMENTING
  CLOSED_CONFIRMED
  CLOSED_INVALIDATED
  CLOSED_INCONCLUSIVE
}

enum OOSCasePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model OOSCase {
  id              String          @id @default(uuid())
  caseNumber      String          @unique
  caseType        OOSCaseType     @default(OOS)
  priority        OOSCasePriority @default(MEDIUM)
  status          OOSCaseStatus   @default(OPEN)
  
  batchId         String
  batch           Batch           @relation(fields: [batchId], references: [id])
  
  testResultId    String?
  testName        String
  testMethod      String?
  specMin         Float?
  specMax         Float?
  actualValue     Float?
  unit            String?
  deviationPercent Float?
  
  openedAt        DateTime        @default(now())
  openedById      String
  openedBy        User            @relation("OOSOpener", fields: [openedById], references: [id])
  
  initialDescription     String
  
  phase1StartedAt       DateTime?
  phase1InvestigatorId  String?
  phase1Investigator    User?     @relation("OOSPhase1Investigator", fields: [phase1InvestigatorId], references: [id])
  phase1LabChecks       Json?
  phase1Retesting       Json?
  phase1Findings        String?
  phase1CompletedAt     DateTime?
  phase1Conclusion      String?
  
  phase2StartedAt       DateTime?
  phase2LeadId          String?
  phase2Lead            User?     @relation("OOSPhase2Lead", fields: [phase2LeadId], references: [id])
  phase2RootCauseAnalysis String?
  phase2ImpactAssessment  String?
  phase2AffectedBatches   Json?
  phase2Findings        String?
  phase2CompletedAt     DateTime?
  phase2Conclusion      String?
  
  rootCause             String?
  correctiveAction      String?
  preventiveAction      String?
  capaProposedAt        DateTime?
  capaProposedById      String?
  capaProposedBy        User?     @relation("OOSCAPAProposer", fields: [capaProposedById], references: [id])
  
  capaApprovedAt        DateTime?
  capaApprovedById      String?
  capaApprovedBy        User?     @relation("OOSCAPAApprover", fields: [capaApprovedById], references: [id])
  capaApprovalSignatureId String?
  capaApprovalSignature ESignature? @relation("OOSCAPAApprovalSignature", fields: [capaApprovalSignatureId], references: [id])
  
  capaImplementationNotes String?
  capaEffectivenessCheck  String?
  
  finalConclusion       String?
  closureType           String?
  closedAt              DateTime?
  closedById            String?
  closedBy              User?     @relation("OOSCloser", fields: [closedById], references: [id])
  closureSignatureId    String?
  closureSignature      ESignature? @relation("OOSClosureSignature", fields: [closureSignatureId], references: [id])
  
  dueDate               DateTime?
  isOverdue             Boolean   @default(false)
  
  attachments           OOSAttachment[]
  timeline              OOSTimeline[]
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([batchId])
  @@index([status])
  @@index([caseType])
  @@index([priority])
  @@index([openedById])
}

model OOSAttachment {
  id          String   @id @default(uuid())
  oosCaseId   String
  oosCase     OOSCase  @relation(fields: [oosCaseId], references: [id], onDelete: Cascade)
  fileName    String
  fileType    String
  fileSize    Int
  storagePath String
  description String?
  phase       String?
  uploadedById String
  uploadedAt  DateTime @default(now())
  
  @@index([oosCaseId])
}

model OOSTimeline {
  id          String   @id @default(uuid())
  oosCaseId   String
  oosCase     OOSCase  @relation(fields: [oosCaseId], references: [id], onDelete: Cascade)
  action      String
  description String
  oldStatus   String?
  newStatus   String?
  userId      String
  createdAt   DateTime @default(now())
  
  @@index([oosCaseId])
  @@index([createdAt])
}

// ==================== LOGISTICS ====================

enum ShipmentStatus {
  DRAFT
  READY_TO_PACK
  PACKED
  ASSIGNED_TO_DRIVER
  ACCEPTED_BY_DRIVER
  PICKED_UP
  IN_TRANSIT
  ARRIVED
  DELIVERED
  DELIVERY_FAILED
  RETURNED
  CANCELLED
  DELAYED
}

enum VehicleType {
  CAR
  VAN
  MOTORCYCLE
}

enum DriverStatus {
  ACTIVE
  INACTIVE
}

enum ShipmentPriority {
  NORMAL
  URGENT
}

// ==================== DRIVER MANAGEMENT ====================

model Driver {
  id                String       @id @default(uuid())
  fullName          String
  mobile            String
  email             String?
  nationalId        String?
  driverLicenseNo   String?
  licenseExpiryDate DateTime?
  vehicleType       VehicleType  @default(CAR)
  vehiclePlateNo    String?
  vehicleModel      String?
  status            DriverStatus @default(ACTIVE)
  photoUrl          String?
  userId            String?      @unique
  user              User?        @relation(fields: [userId], references: [id])
  shipments         Shipment[]
  assignedShipments Shipment[]   @relation("ShipmentAssigner")
  availability      DriverAvailability[]
  proofOfDeliveries ProofOfDelivery[]
  shipmentEvents    ShipmentEvent[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

model DriverAvailability {
  id          String   @id @default(uuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id])
  date        DateTime
  startTime   String
  endTime     String
  isAvailable Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ShipmentEvent {
  id          String   @id @default(uuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id])
  eventType   String
  fromStatus  ShipmentStatus?
  toStatus    ShipmentStatus?
  driverId    String?
  driver      Driver?  @relation(fields: [driverId], references: [id])
  userId      String?
  notes       String?
  latitude    Float?
  longitude   Float?
  metadata    Json?
  createdAt   DateTime @default(now())
}

model ProofOfDelivery {
  id              String    @id @default(uuid())
  shipmentId      String    @unique
  shipment        Shipment  @relation(fields: [shipmentId], references: [id])
  deliveredAt     DateTime
  receiverName    String
  receiverMobile  String?
  receiverIdType  String?
  signatureFileUrl String?
  gpsLat          Float?
  gpsLng          Float?
  notes           String?
  capturedByDriverId String?
  capturedByDriver   Driver?  @relation(fields: [capturedByDriverId], references: [id])
  photos          ProofOfDeliveryPhoto[]
  createdAt       DateTime  @default(now())
}

model ProofOfDeliveryPhoto {
  id        String          @id @default(uuid())
  podId     String
  pod       ProofOfDelivery @relation(fields: [podId], references: [id])
  fileUrl   String
  caption   String?
  createdAt DateTime        @default(now())
}

model Shipment {
  id                     String           @id @default(uuid())
  shipmentNumber         String           @unique
  customerId             String
  customer               Customer         @relation(fields: [customerId], references: [id])
  driverId               String?
  driver                 Driver?          @relation(fields: [driverId], references: [id])
  assignedAt             DateTime?
  assignedByDriverId     String?
  assignedByDriver       Driver?          @relation("ShipmentAssigner", fields: [assignedByDriverId], references: [id])
  courierId              String?
  courierName            String?
  vehicleInfo            String?
  routeInfo              String?
  scheduledPickupAt      DateTime?
  scheduledDeliveryAt    DateTime?
  scheduledDepartureTime DateTime?
  actualDepartureTime    DateTime?
  expectedArrivalTime    DateTime?
  actualArrivalTime      DateTime?
  pickupAddress          String?
  deliveryAddress        String?
  deliveryLat            Float?
  deliveryLng            Float?
  specialHandling        String?
  currentLocationLat     Float?
  currentLocationLng     Float?
  lastCheckpointAt       DateTime?
  priority               ShipmentPriority @default(NORMAL)
  activityAtDispatch     Float?
  activityAtDelivery     Float?
  receiverName           String?
  receiverSignature      String?
  status                 ShipmentStatus   @default(PACKED)
  notes                  String?
  driverNotes            String?
  orders                 Order[]
  doseUnits              DoseUnit[]
  events                 ShipmentEvent[]
  proofOfDelivery        ProofOfDelivery?
  createdAt              DateTime         @default(now())
  updatedAt              DateTime         @updatedAt
}

// ==================== NOTIFICATIONS ====================

enum NotificationType {
  ORDER_SUBMITTED
  ORDER_VALIDATED
  SCHEDULE_CHANGED
  QC_PASSED
  QC_FAILED
  BATCH_RELEASED
  DISPATCH_UPDATE
  DELIVERY_UPDATE
  SYSTEM
}

model Notification {
  id               String           @id @default(uuid())
  userId           String
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type             NotificationType
  title            String
  message          String
  isRead           Boolean          @default(false)
  relatedId        String?
  relatedType      String?
  createdAt        DateTime         @default(now())
  deliveryAttempts NotificationDeliveryAttempt[]
}

// ==================== NOTIFICATION CHANNELS ====================

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  WHATSAPP
}

enum NotificationProviderType {
  SMTP
  RESEND
  TWILIO
  META_WHATSAPP
}

enum DeliveryStatus {
  PENDING
  SENT
  FAILED
  SKIPPED
}

model NotificationChannelConfig {
  id                   String                   @id @default(uuid())
  channel              NotificationChannel      @unique
  isEnabled            Boolean                  @default(false)
  providerType         NotificationProviderType
  settingsJson         Json?
  encryptedSecretsJson String?
  fromName             String?
  fromAddress          String?
  lastTestedAt         DateTime?
  lastTestStatus       DeliveryStatus?
  lastTestMessage      String?
  updatedAt            DateTime                 @updatedAt
  updatedByUserId      String?
  updatedBy            User?                    @relation("NotificationChannelUpdatedBy", fields: [updatedByUserId], references: [id])

  @@map("notification_channel_configs")
}

model NotificationDeliveryAttempt {
  id                String              @id @default(uuid())
  notificationId    String?
  notification      Notification?       @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  channel           NotificationChannel
  recipientAddress  String
  status            DeliveryStatus      @default(PENDING)
  providerMessageId String?
  errorMessage      String?
  metadata          Json?
  attemptedAt       DateTime            @default(now())

  @@index([channel])
  @@index([status])
  @@index([attemptedAt])
  @@map("notification_delivery_attempts")
}

model UserNotificationPreference {
  id                   String  @id @default(uuid())
  userId               String  @unique
  user                 User    @relation("UserNotificationPreference", fields: [userId], references: [id], onDelete: Cascade)
  emailEnabled         Boolean @default(true)
  smsEnabled           Boolean @default(true)
  whatsappEnabled      Boolean @default(true)
  minSeverity          String  @default("INFO")
  updatedAt            DateTime @updatedAt

  @@map("user_notification_preferences")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  action      String
  entityType  String
  entityId    String?
  actorRole   String?
  traceId     String?
  oldValues   Json?
  newValues   Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([traceId])
  @@index([createdAt])
}

// ==================== CONFIGURATION ====================

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  dataType  String   @default("string")
  category  String?
  description String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ProductionSlot {
  id            String   @id @default(uuid())
  slotDate      DateTime
  slotStartTime DateTime
  slotEndTime   DateTime
  equipmentId   String?
  equipmentType String
  isAvailable   Boolean  @default(true)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ==================== WORKFLOW APPROVAL SYSTEM ====================

enum WorkflowEntityType {
  ORDER
  BATCH
  QC_RESULT
  BATCH_RELEASE
  SHIPMENT
  CUSTOMER
  PRODUCT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
  CANCELLED
}

model WorkflowDefinition {
  id                String              @id @default(uuid())
  name              String              @unique
  entityType        WorkflowEntityType
  triggerStatus     String?
  description       String?
  isActive          Boolean             @default(true)
  requiresAllSteps  Boolean             @default(true)
  steps             ApprovalStep[]
  approvalRequests  ApprovalRequest[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
}

model ApprovalStep {
  id                  String             @id @default(uuid())
  workflowId          String
  workflow            WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  stepOrder           Int
  stepName            String
  description         String?
  approverRoleId      String
  approverRole        Role               @relation(fields: [approverRoleId], references: [id])
  timeoutHours        Int?
  isRequired          Boolean            @default(true)
  canDelegate         Boolean            @default(false)
  approvalActions     ApprovalAction[]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@unique([workflowId, stepOrder])
}

model ApprovalRequest {
  id                String             @id @default(uuid())
  workflowId        String
  workflow          WorkflowDefinition @relation(fields: [workflowId], references: [id])
  entityType        WorkflowEntityType
  entityId          String
  requestedById     String
  requestedBy       User               @relation("ApprovalRequester", fields: [requestedById], references: [id])
  currentStepOrder  Int                @default(1)
  status            ApprovalStatus     @default(PENDING)
  priority          String             @default("NORMAL")
  dueDate           DateTime?
  completedAt       DateTime?
  notes             String?
  actions           ApprovalAction[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([entityType, entityId])
  @@index([status])
}

model ApprovalAction {
  id                String          @id @default(uuid())
  approvalRequestId String
  approvalRequest   ApprovalRequest @relation(fields: [approvalRequestId], references: [id], onDelete: Cascade)
  stepId            String
  step              ApprovalStep    @relation(fields: [stepId], references: [id])
  actionById        String
  actionBy          User            @relation("ApprovalActor", fields: [actionById], references: [id])
  action            ApprovalStatus
  comments          String?
  signature         String?
  actionAt          DateTime        @default(now())

  @@index([approvalRequestId])
}

// ==================== DOSE DISPENSING ====================

enum DoseUnitStatus {
  CREATED
  LABELED
  DISPENSED
  SHIPPED
  DELIVERED
  CANCELLED
  WASTED
}

model DoseUnit {
  id                  String         @id @default(uuid())
  doseNumber          String         @unique
  batchId             String
  batch               Batch          @relation(fields: [batchId], references: [id])
  orderId             String?
  order               Order?         @relation(fields: [orderId], references: [id])
  patientReference    String?
  requestedActivity   Float
  dispensedActivity   Float?
  calibrationTime     DateTime?
  activityUnit        String         @default("mCi")
  volume              Float?
  volumeUnit          String         @default("mL")
  containerType       String?
  labelData           Json?
  labelPrinted        Boolean        @default(false)
  labelPrintedAt      DateTime?
  dispensedById       String?
  dispensedBy         User?          @relation("DoseDispenser", fields: [dispensedById], references: [id])
  dispensedAt         DateTime?
  status              DoseUnitStatus @default(CREATED)
  releaseInheritedFromBatch Boolean  @default(true)
  notes               String?
  shipmentId          String?
  shipment            Shipment?      @relation(fields: [shipmentId], references: [id])
  invoiceItemId       String?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
}

// ==================== CAPACITY & SLOT MANAGEMENT ====================

enum ResourceType {
  CYCLOTRON
  SYNTHESIS_MODULE
  HOT_CELL
  DISPENSING_CELL
  QC_LAB
}

model ResourceCalendar {
  id              String       @id @default(uuid())
  resourceId      String
  resource        Equipment    @relation(fields: [resourceId], references: [id])
  date            DateTime     @db.Date
  startTime       DateTime
  endTime         DateTime
  capacityMinutes Int
  usedMinutes     Int          @default(0)
  isAvailable     Boolean      @default(true)
  notes           String?
  slots           DeliverySlot[]
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@unique([resourceId, date])
}

model DeliveryWindow {
  id              String         @id @default(uuid())
  name            String
  date            DateTime       @db.Date
  startTime       DateTime
  endTime         DateTime
  capacityMinutes Int
  usedMinutes     Int            @default(0)
  isActive        Boolean        @default(true)
  slots           DeliverySlot[]
  reservations    Reservation[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([date, startTime, endTime])
}

model DeliverySlot {
  id                String           @id @default(uuid())
  windowId          String
  window            DeliveryWindow   @relation(fields: [windowId], references: [id], onDelete: Cascade)
  resourceCalendarId String?
  resourceCalendar  ResourceCalendar? @relation(fields: [resourceCalendarId], references: [id])
  slotTime          DateTime
  durationMinutes   Int
  capacityMinutes   Int
  usedMinutes       Int              @default(0)
  isAvailable       Boolean          @default(true)
  reservations      Reservation[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([windowId, slotTime])
}

// ==================== RESERVATIONS ====================

enum ReservationStatus {
  TENTATIVE
  CONFIRMED
  CONVERTED
  CANCELLED
  EXPIRED
}

model Reservation {
  id                String            @id @default(uuid())
  reservationNumber String            @unique
  customerId        String
  customer          Customer          @relation(fields: [customerId], references: [id])
  productId         String
  product           Product           @relation(fields: [productId], references: [id])
  windowId          String?
  window            DeliveryWindow?   @relation(fields: [windowId], references: [id])
  slotId            String?
  slot              DeliverySlot?     @relation(fields: [slotId], references: [id])
  requestedDate     DateTime
  requestedActivity Float
  activityUnit      String            @default("mCi")
  estimatedMinutes  Int
  numberOfDoses     Int               @default(1)
  status            ReservationStatus @default(TENTATIVE)
  convertedOrderId  String?
  expiresAt         DateTime?
  notes             String?
  createdById       String?
  orders            Order[]
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([customerId, requestedDate])
  @@index([status])
}

// ==================== CONTRACTS & PRICING ====================

enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

model Contract {
  id              String         @id @default(uuid())
  contractNumber  String         @unique
  customerId      String
  customer        Customer       @relation(fields: [customerId], references: [id])
  name            String
  startDate       DateTime
  endDate         DateTime
  paymentTermsDays Int           @default(30)
  creditLimit     Float?
  discountPercent Float          @default(0)
  status          ContractStatus @default(DRAFT)
  notes           String?
  priceItems      ContractPriceItem[]
  invoices        Invoice[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([customerId])
  @@index([status])
}

model ContractPriceItem {
  id              String   @id @default(uuid())
  contractId      String
  contract        Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  productId       String
  product         Product  @relation(fields: [productId], references: [id])
  unitPrice       Float
  priceUnit       String   @default("per mCi")
  minimumQuantity Float?
  discountPercent Float    @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([contractId, productId])
}

// ==================== INVOICING & AR ====================

enum InvoiceStatus {
  DRAFT
  PENDING_APPROVAL
  ISSUED_POSTED
  PARTIALLY_PAID
  PAID
  CLOSED_ARCHIVED
  CANCELLED_VOIDED
  OVERDUE
  DISPUTED
}

enum InvoiceGenerationTrigger {
  ON_DELIVERED
  ON_DISPATCHED
  ON_QP_RELEASED
  MANUAL_ONLY
}

model Invoice {
  id                  String        @id @default(uuid())
  invoiceNumber       String        @unique
  customerId          String
  customer            Customer      @relation(fields: [customerId], references: [id])
  contractId          String?
  contract            Contract?     @relation(fields: [contractId], references: [id])
  orderId             String?
  shipmentId          String?
  invoiceDate         DateTime      @default(now())
  dueDate             DateTime
  subtotal            Float         @default(0)
  taxAmount           Float         @default(0)
  discountAmount      Float         @default(0)
  totalAmount         Float         @default(0)
  paidAmount          Float         @default(0)
  remainingAmount     Float         @default(0)
  currency            String        @default("SAR")
  fxRateToSAR         Float         @default(1)
  totalAmountSAR      Float         @default(0)
  allowPartialPayment Boolean       @default(true)
  minInstallmentAmount Float?
  status              InvoiceStatus @default(DRAFT)
  triggerSource       InvoiceGenerationTrigger?
  postedAt            DateTime?
  issuedAt            DateTime?
  closedAt            DateTime?
  approvedByUserId    String?
  approvedBy          User?         @relation("InvoiceApprover", fields: [approvedByUserId], references: [id])
  notes               String?
  zatcaStatus         ZatcaSubmissionStatus @default(NOT_SENT)
  items               InvoiceItem[]
  payments            Payment[]
  paymentRequests     PaymentRequest[]
  receiptVouchers     ReceiptVoucher[]
  events              InvoiceEvent[]
  zatcaSubmissions    ZatcaSubmission[]
  zatcaQrPayloads     ZatcaQrPayload[]
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  @@index([customerId])
  @@index([status])
  @@index([zatcaStatus])
  @@index([dueDate])
  @@index([orderId])
  @@index([shipmentId])
}

model InvoiceEvent {
  id          String   @id @default(uuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  eventType   String
  description String?
  userId      String?
  user        User?    @relation("InvoiceEventUser", fields: [userId], references: [id])
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([invoiceId])
  @@index([eventType])
}

model PaymentEvent {
  id               String   @id @default(uuid())
  paymentRequestId String?
  receiptVoucherId String?
  eventType        String
  description      String?
  userId           String?
  metadata         Json?
  createdAt        DateTime @default(now())

  @@index([paymentRequestId])
  @@index([receiptVoucherId])
}

model InvoiceItem {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  orderId         String?
  doseUnitId      String?
  description     String
  productId       String?
  product         Product? @relation(fields: [productId], references: [id])
  quantity        Float
  unitPrice       Float
  discountPercent Float    @default(0)
  taxPercent      Float    @default(0)
  lineTotal       Float
  createdAt       DateTime @default(now())
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  invoice         Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paymentDate     DateTime @default(now())
  amount          Float
  amountSAR       Float    @default(0)
  paymentMethod   String
  referenceNumber String?
  notes           String?
  receiptVoucherId String?
  receiptVoucher  ReceiptVoucher? @relation(fields: [receiptVoucherId], references: [id])
  createdAt       DateTime @default(now())
}

enum PaymentRequestStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  REJECTED
}

model PaymentRequest {
  id              String               @id @default(uuid())
  invoiceId       String
  invoice         Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  customerId      String
  customer        Customer             @relation(fields: [customerId], references: [id])
  amount          Float
  amountSAR       Float                @default(0)
  currency        String               @default("SAR")
  paymentMethod   String
  referenceNumber String?
  proofUrl        String?
  notes           String?
  status          PaymentRequestStatus @default(PENDING_CONFIRMATION)
  submittedAt     DateTime             @default(now())
  submittedByUserId String?
  submittedBy     User?                @relation("PaymentRequestSubmitter", fields: [submittedByUserId], references: [id])
  reviewedAt      DateTime?
  reviewedByUserId String?
  reviewedBy      User?                @relation("PaymentRequestReviewer", fields: [reviewedByUserId], references: [id])
  rejectionReason String?
  receiptVoucherId String?             @unique
  receiptVoucher  ReceiptVoucher?      @relation("PaymentRequestReceipt")
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([invoiceId])
  @@index([customerId])
  @@index([status])
}

model ReceiptVoucher {
  id                    String          @id @default(uuid())
  receiptNumber         String          @unique
  invoiceId             String
  invoice               Invoice         @relation(fields: [invoiceId], references: [id])
  customerId            String
  customer              Customer        @relation(fields: [customerId], references: [id])
  paymentRequestId      String?         @unique
  paymentRequest        PaymentRequest? @relation("PaymentRequestReceipt", fields: [paymentRequestId], references: [id])
  amount                Float
  amountSAR             Float
  currency              String          @default("SAR")
  fxRateToSAR           Float           @default(1)
  paymentMethod         String
  referenceNumber       String?
  pdfUrl                String?
  confirmedByUserId     String?
  confirmedBy           User?           @relation("ReceiptConfirmer", fields: [confirmedByUserId], references: [id])
  confirmedAt           DateTime        @default(now())
  payments              Payment[]
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@index([invoiceId])
  @@index([customerId])
}

model ExchangeRate {
  id            String   @id @default(uuid())
  date          DateTime @db.Date
  fromCurrency  String
  toCurrency    String   @default("SAR")
  rate          Float
  source        String   @default("MANUAL") // MANUAL or API
  isActive      Boolean  @default(true)
  createdBy     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([date, fromCurrency, toCurrency])
  @@index([fromCurrency, toCurrency])
  @@index([date])
}

model UserPreference {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  preferredCurrencyCode String   @default("SAR")
  preferredLanguageCode String   @default("en")
  preferredTimezone     String   @default("Asia/Riyadh")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ==================== INTERNATIONALIZATION ====================

model Language {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nativeName  String?
  direction   String   @default("ltr") // ltr or rtl
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  translations TranslationEntry[]
}

model TranslationEntry {
  id          String   @id @default(uuid())
  entityType  String   // PRODUCT, CUSTOMER, MATERIAL, NOTIFICATION_TEMPLATE, REPORT_LABEL, etc.
  entityId    String   // UUID/ID of the entity
  fieldKey    String   // name, description, address, terms, etc.
  langCode    String   // en, ar, fr, etc.
  value       String   @db.Text
  language    Language @relation(fields: [langCode], references: [code])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@unique([entityType, entityId, fieldKey, langCode])
  @@index([entityType, entityId])
  @@index([langCode])
}

model SystemLocalization {
  id                        String   @id @default(uuid())
  defaultLanguageCode       String   @default("en")
  defaultTimezone           String   @default("Asia/Riyadh")
  baseCurrencyCode          String   @default("SAR")
  enableMultiCurrencyDisplay Boolean  @default(true)
  enableUserLanguageOverride Boolean  @default(true)
  enableUserTimezoneOverride Boolean  @default(true)
  enableUserCurrencyOverride Boolean  @default(true)
  dateFormat                String   @default("yyyy-MM-dd")
  timeFormat                String   @default("HH:mm")
  numberFormat              String   @default("en-US") // locale for number formatting
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// ==================== TIME STANDARDS ====================

model TimeStandard {
  id              String    @id @default(uuid())
  productId       String
  product         Product   @relation(fields: [productId], references: [id])
  processType     String
  doseForm        String?
  standardMinutes Int
  description     String?
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([productId, processType])
  @@index([effectiveFrom, effectiveTo])
}

// ==================== SYSTEM SETTINGS ====================

model SettingCountry {
  id          String          @id @default(uuid())
  code        String          @unique
  name        String
  nameAr      String?
  isActive    Boolean         @default(true)
  cities      SettingCity[]
  regions     SettingRegion[]
  customers   Customer[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model SettingCity {
  id          String          @id @default(uuid())
  countryId   String
  country     SettingCountry  @relation(fields: [countryId], references: [id])
  regionId    String?
  region      SettingRegion?  @relation(fields: [regionId], references: [id])
  code        String
  name        String
  nameAr      String?
  isActive    Boolean         @default(true)
  customers   Customer[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([countryId, code])
}

model SettingRegion {
  id          String          @id @default(uuid())
  countryId   String
  country     SettingCountry  @relation(fields: [countryId], references: [id])
  code        String
  name        String
  nameAr      String?
  isActive    Boolean         @default(true)
  customers   Customer[]
  cities      SettingCity[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([countryId, code])
}

model SettingCategory {
  id          String     @id @default(uuid())
  code        String     @unique
  name        String
  nameAr      String?
  description String?
  isActive    Boolean    @default(true)
  customers   Customer[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model SettingCourier {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  vehicles    SettingVehicle[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingVehicle {
  id            String          @id @default(uuid())
  courierId     String?
  courier       SettingCourier? @relation(fields: [courierId], references: [id])
  plateNumber   String          @unique
  vehicleType   String
  model         String?
  capacity      String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model SettingDoseUnit {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  symbol      String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingProductType {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingProductionMethod {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameAr      String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SettingCurrency {
  id            String   @id @default(uuid())
  code          String   @unique
  name          String
  nameAr        String?
  symbol        String
  exchangeRate  Float    @default(1.0)
  isDefault     Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SystemSettings {
  id            String   @id @default("default")
  timezone      String   @default("Asia/Riyadh")
  language      String   @default("en")
  dateFormat    String   @default("yyyy-MM-dd")
  timeFormat    String   @default("HH:mm")
  currencyCode  String   @default("SAR")
  companyName   String?
  companyNameAr String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ==================== ATTACHMENT SYSTEM ====================

model AttachmentType {
  id          String   @id @default(uuid())
  name        String
  extensions  String[]
  mimeTypes   String[]
  maxSizeMB   Float    @default(5.0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  attachments Attachment[]
}

model Attachment {
  id              String         @id @default(uuid())
  fileName        String
  originalName    String
  mimeType        String
  fileSize        Int
  filePath        String
  description     String?
  
  entityType      String
  entityId        String
  
  attachmentTypeId String?
  attachmentType   AttachmentType? @relation(fields: [attachmentTypeId], references: [id])
  
  uploadedById    String
  uploadedBy      User           @relation(fields: [uploadedById], references: [id])
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([entityType, entityId])
}

// ==================== PROCUREMENT & SUPPLY CHAIN ====================

enum SupplierStatus {
  ACTIVE
  ON_HOLD
  BLOCKED
}

model Supplier {
  id              String         @id @default(uuid())
  code            String         @unique
  name            String
  nameAr          String?
  email           String?
  phone           String?
  mobile          String?
  website         String?
  
  // Tax & Financial
  taxNumber       String?
  vatNumber       String?
  crNumber        String?        // Commercial Registration
  
  // Bank Information
  bankName        String?
  bankBranch      String?
  bankAccountName String?
  bankAccountNumber String?
  bankIban        String?
  bankSwift       String?
  
  // Address
  address         String?
  city            String?
  region          String?
  country         String?
  postalCode      String?
  
  // Terms
  paymentTermsDays Int           @default(30)
  currencyCode    String         @default("SAR")
  
  status          SupplierStatus @default(ACTIVE)
  notes           String?
  
  contacts        SupplierContact[]
  documents       SupplierDocument[]
  rfqQuotes       RFQQuote[]
  purchaseOrders  PurchaseOrder[]
  grns            GoodsReceivedNote[]
  invoices        SupplierInvoice[]
  materials       Material[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

model SupplierContact {
  id          String   @id @default(uuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  name        String
  title       String?
  email       String?
  phone       String?
  mobile      String?
  isPrimary   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum SupplierDocType {
  CONTRACT
  LICENSE
  CERTIFICATE
  TAX_CERT
  INSURANCE
  QUALITY_CERT
  OTHER
}

model SupplierDocument {
  id          String          @id @default(uuid())
  supplierId  String
  supplier    Supplier        @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  docType     SupplierDocType
  docName     String
  fileName    String
  filePath    String
  mimeType    String
  fileSizeBytes Int
  expiryDate  DateTime?
  notes       String?
  uploadedById String
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

// Request for Quotation
enum RFQStatus {
  DRAFT
  SENT
  QUOTES_RECEIVED
  EVALUATED
  APPROVED
  CANCELLED
  EXPIRED
}

model RFQ {
  id              String     @id @default(uuid())
  rfqNumber       String     @unique
  title           String
  description     String?
  
  requiredByDate  DateTime?
  validUntilDate  DateTime?
  
  status          RFQStatus  @default(DRAFT)
  
  // Source info (optional)
  sourceType      String?    // MANUAL, PRODUCTION_DEMAND, REORDER
  sourceId        String?
  
  notes           String?
  
  items           RFQItem[]
  quotes          RFQQuote[]
  selectedQuoteId String?
  
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model RFQItem {
  id              String   @id @default(uuid())
  rfqId           String
  rfq             RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  
  itemCode        String
  itemName        String
  description     String?
  quantity        Float
  unit            String   @default("EA")
  
  specifications  String?
  
  quoteItems      RFQQuoteItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model RFQQuote {
  id              String   @id @default(uuid())
  rfqId           String
  rfq             RFQ      @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplierId      String
  supplier        Supplier @relation(fields: [supplierId], references: [id])
  
  quoteNumber     String?
  quoteDate       DateTime @default(now())
  validUntilDate  DateTime?
  leadTimeDays    Int?
  
  totalAmount     Decimal  @db.Decimal(12, 2)
  currencyCode    String   @default("SAR")
  
  paymentTerms    String?
  deliveryTerms   String?
  notes           String?
  
  isSelected      Boolean  @default(false)
  
  items           RFQQuoteItem[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([rfqId, supplierId])
}

model RFQQuoteItem {
  id              String      @id @default(uuid())
  quoteId         String
  quote           RFQQuote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  rfqItemId       String
  rfqItem         RFQItem     @relation(fields: [rfqItemId], references: [id])
  
  unitPrice       Decimal     @db.Decimal(12, 4)
  quantity        Float
  totalPrice      Decimal     @db.Decimal(12, 2)
  
  leadTimeDays    Int?
  notes           String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Purchase Orders
enum POStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  SENT
  ACKNOWLEDGED
  PARTIALLY_RECEIVED
  RECEIVED
  CLOSED
  CANCELLED
}

model PurchaseOrder {
  id              String     @id @default(uuid())
  poNumber        String     @unique
  supplierId      String
  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  
  // Source (optional - from RFQ)
  rfqId           String?
  quoteId         String?
  
  orderDate       DateTime   @default(now())
  expectedDate    DateTime?
  
  status          POStatus   @default(DRAFT)
  
  // Amounts
  subtotal        Decimal    @db.Decimal(12, 2)
  taxAmount       Decimal    @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal    @db.Decimal(12, 2)
  currencyCode    String     @default("SAR")
  
  paymentTermsDays Int       @default(30)
  deliveryTerms   String?
  shippingAddress String?
  
  notes           String?
  
  items           PurchaseOrderItem[]
  grns            GoodsReceivedNote[]
  invoices        SupplierInvoice[]
  threeWayMatches ThreeWayMatch[]
  
  createdById     String
  createdBy       User       @relation("POCreator", fields: [createdById], references: [id])
  approvedById    String?
  approvedBy      User?      @relation("POApprover", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  sentAt          DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model PurchaseOrderItem {
  id              String         @id @default(uuid())
  poId            String
  purchaseOrder   PurchaseOrder  @relation(fields: [poId], references: [id], onDelete: Cascade)
  
  lineNumber      Int
  itemCode        String
  itemName        String
  description     String?
  
  orderedQty      Float
  receivedQty     Float          @default(0)
  unit            String         @default("EA")
  
  unitPrice       Decimal        @db.Decimal(12, 4)
  totalPrice      Decimal        @db.Decimal(12, 2)
  
  grnItems        GRNItem[]
  invoiceItems    SupplierInvoiceItem[]
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}

// Goods Received Note (Receiving)
enum GRNStatus {
  DRAFT
  PENDING_QC
  APPROVED
  PARTIALLY_APPROVED
  REJECTED
}

model GoodsReceivedNote {
  id              String     @id @default(uuid())
  grnNumber       String     @unique
  
  poId            String
  purchaseOrder   PurchaseOrder @relation(fields: [poId], references: [id])
  supplierId      String
  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  
  receivedDate    DateTime   @default(now())
  deliveryNoteNumber String?
  
  status          GRNStatus  @default(DRAFT)
  
  notes           String?
  
  items           GRNItem[]
  threeWayMatches ThreeWayMatch[]
  
  receivedById    String
  approvedById    String?
  approvedAt      DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

enum GRNItemStatus {
  QUARANTINE
  RELEASED
  REJECTED
}

model GRNItem {
  id              String     @id @default(uuid())
  grnId           String
  grn             GoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  poItemId        String
  poItem          PurchaseOrderItem @relation(fields: [poItemId], references: [id])
  
  receivedQty     Float
  acceptedQty     Float      @default(0)
  rejectedQty     Float      @default(0)
  unit            String     @default("EA")
  
  // Lot tracking
  lotNumber       String?
  batchNumber     String?
  expiryDate      DateTime?
  manufacturingDate DateTime?
  
  // Storage location
  warehouseId     String?
  binLocation     String?
  
  status          GRNItemStatus @default(QUARANTINE)
  
  notes           String?
  rejectionReason String?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

// Supplier Invoices
enum SupplierInvoiceStatus {
  DRAFT
  PENDING_MATCH
  MATCHED
  DISCREPANCY
  PENDING_APPROVAL
  APPROVED
  POSTED
  PAID
  CANCELLED
}

model SupplierInvoice {
  id              String     @id @default(uuid())
  invoiceNumber   String     @unique
  supplierInvoiceNumber String?
  
  supplierId      String
  supplier        Supplier   @relation(fields: [supplierId], references: [id])
  poId            String?
  purchaseOrder   PurchaseOrder? @relation(fields: [poId], references: [id])
  
  invoiceDate     DateTime
  dueDate         DateTime?
  
  status          SupplierInvoiceStatus @default(DRAFT)
  
  // Amounts
  subtotal        Decimal    @db.Decimal(12, 2)
  taxAmount       Decimal    @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal    @db.Decimal(12, 2)
  paidAmount      Decimal    @db.Decimal(12, 2) @default(0)
  currencyCode    String     @default("SAR")
  
  notes           String?
  
  items           SupplierInvoiceItem[]
  threeWayMatches ThreeWayMatch[]
  
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  postedAt        DateTime?
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model SupplierInvoiceItem {
  id              String          @id @default(uuid())
  invoiceId       String
  invoice         SupplierInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  poItemId        String?
  poItem          PurchaseOrderItem? @relation(fields: [poItemId], references: [id])
  
  lineNumber      Int
  itemCode        String
  itemName        String
  description     String?
  
  quantity        Float
  unit            String          @default("EA")
  unitPrice       Decimal         @db.Decimal(12, 4)
  totalPrice      Decimal         @db.Decimal(12, 2)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// 3-Way Match
enum MatchStatus {
  PENDING
  MATCHED
  DISCREPANCY
  APPROVED_WITH_OVERRIDE
  REJECTED
}

model ThreeWayMatch {
  id              String          @id @default(uuid())
  matchNumber     String          @unique
  
  poId            String
  purchaseOrder   PurchaseOrder   @relation(fields: [poId], references: [id])
  grnId           String
  grn             GoodsReceivedNote @relation(fields: [grnId], references: [id])
  invoiceId       String
  invoice         SupplierInvoice @relation(fields: [invoiceId], references: [id])
  
  status          MatchStatus     @default(PENDING)
  
  // Variance tracking
  qtyVariance     Float           @default(0)
  priceVariance   Decimal         @db.Decimal(12, 2) @default(0)
  
  // Override approval (when discrepancy approved)
  overrideReason  String?
  overrideById    String?
  overrideAt      DateTime?
  
  matchedById     String?
  matchedAt       DateTime?
  
  notes           String?
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// ==================== INVENTORY & WAREHOUSE ====================

enum WarehouseType {
  RAW_MATERIALS
  QUARANTINE
  PRODUCTION
  FINISHED_GOODS
  COLD_STORAGE
  RADIOACTIVE
  WASTE
}

enum WarehouseStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model Warehouse {
  id              String          @id @default(uuid())
  code            String          @unique
  name            String
  nameAr          String?
  type            WarehouseType   @default(RAW_MATERIALS)
  status          WarehouseStatus @default(ACTIVE)
  
  description     String?
  address         String?
  
  temperatureMin  Float?
  temperatureMax  Float?
  humidityMin     Float?
  humidityMax     Float?
  
  isRadioactive   Boolean         @default(false)
  requiresQC      Boolean         @default(true)
  
  locations       WarehouseLocation[]
  stockItems      StockItem[]
  stockMovements  StockMovement[]
  batchMaterialConsumptions BatchMaterialConsumption[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

model WarehouseLocation {
  id              String          @id @default(uuid())
  warehouseId     String
  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  code            String
  name            String
  
  zone            String?
  aisle           String?
  rack            String?
  shelf           String?
  bin             String?
  
  capacity        Float?
  capacityUnit    String?
  
  isActive        Boolean         @default(true)
  
  stockItems      StockItem[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([warehouseId, code])
}

enum StockStatus {
  AVAILABLE
  QUARANTINE
  RESERVED
  ON_HOLD
  EXPIRED
  REJECTED
}

model StockItem {
  id              String          @id @default(uuid())
  
  materialId      String
  material        Material        @relation(fields: [materialId], references: [id])
  
  warehouseId     String
  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id])
  
  locationId      String?
  location        WarehouseLocation? @relation(fields: [locationId], references: [id])
  
  quantity        Float           @default(0)
  reservedQty     Float           @default(0)
  availableQty    Float           @default(0)
  unit            String          @default("EA")
  
  lotNumber       String?
  batchNumber     String?
  serialNumber    String?
  
  expiryDate      DateTime?
  manufacturingDate DateTime?
  receivedDate    DateTime?
  
  status          StockStatus     @default(AVAILABLE)
  
  unitCost        Decimal?        @db.Decimal(12, 4)
  totalValue      Decimal?        @db.Decimal(12, 2)
  
  supplierId      String?
  grnItemId       String?
  poNumber        String?
  
  notes           String?
  
  movements       StockMovement[]
  batchMaterialConsumptions BatchMaterialConsumption[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([materialId])
  @@index([warehouseId])
  @@index([lotNumber])
  @@index([status])
}

enum MovementType {
  RECEIPT
  ISSUE
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT_IN
  ADJUSTMENT_OUT
  RETURN
  SCRAP
  PRODUCTION_ISSUE
  PRODUCTION_RECEIPT
}

model StockMovement {
  id              String          @id @default(uuid())
  movementNumber  String          @unique
  
  stockItemId     String
  stockItem       StockItem       @relation(fields: [stockItemId], references: [id])
  
  warehouseId     String
  warehouse       Warehouse       @relation(fields: [warehouseId], references: [id])
  
  type            MovementType
  
  quantity        Float
  unit            String          @default("EA")
  
  fromLocationId  String?
  toLocationId    String?
  
  referenceType   String?
  referenceId     String?
  referenceNumber String?
  
  reason          String?
  notes           String?
  
  performedById   String
  performedAt     DateTime        @default(now())
  
  batchMaterialConsumptions BatchMaterialConsumption[]
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([stockItemId])
  @@index([warehouseId])
  @@index([type])
  @@index([performedAt])
}


// ==================== ZATCA E-INVOICE INTEGRATION ====================

enum ZatcaEnvironment {
  SIMULATION
  PRODUCTION
}

enum ZatcaCredentialStatus {
  DRAFT
  COMPLIANCE_READY
  ACTIVE
  REVOKED
}

enum ZatcaSubmissionStatus {
  NOT_SENT
  PENDING
  ACCEPTED
  CLEARED
  REPORTED
  REJECTED
  FAILED
}

enum ZatcaApiType {
  REPORTING
  CLEARANCE
}

enum ZatcaDocType {
  INVOICE
  CREDIT_NOTE
  DEBIT_NOTE
}

enum ZatcaQrVersion {
  PHASE1_MIN
  PHASE2_SECURITY
}

model ZatcaConfig {
  id                    String            @id @default(uuid())
  environment           ZatcaEnvironment  @default(SIMULATION)
  enableZatcaPosting    Boolean           @default(false)
  modeConfig            Json?
  sellerName            String?
  sellerNameAr          String?
  sellerVatNo           String?
  sellerCrNo            String?
  sellerStreet          String?
  sellerBuilding        String?
  sellerDistrict        String?
  sellerCity            String?
  sellerPostalCode      String?
  sellerCountry         String            @default("SA")
  simplifiedMode        ZatcaApiType      @default(REPORTING)
  standardMode          ZatcaApiType      @default(CLEARANCE)
  retriesCount          Int               @default(3)
  backoffSeconds        Int               @default(60)
  blockUntilAccepted    Boolean           @default(false)
  notifyOnRejection     Boolean           @default(true)
  createdById           String?
  updatedById           String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
}

model ZatcaCredential {
  id                String                  @id @default(uuid())
  deviceName        String
  environment       ZatcaEnvironment        @default(SIMULATION)
  status            ZatcaCredentialStatus   @default(DRAFT)
  csrPem            String?
  keyRef            String?
  ccsidData         Json?
  pcsidData         Json?
  ccsidExpiresAt    DateTime?
  pcsidExpiresAt    DateTime?
  compliancePassed  Boolean                 @default(false)
  complianceErrors  Json?
  lastUsedAt        DateTime?
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt

  @@index([environment])
  @@index([status])
}

model ZatcaSubmission {
  id                    String                @id @default(uuid())
  invoiceId             String
  invoice               Invoice               @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  docType               ZatcaDocType          @default(INVOICE)
  apiType               ZatcaApiType          @default(REPORTING)
  requestUuid           String?
  invoiceHash           String?
  icv                   Int?
  pih                   String?
  signedXml             String?
  status                ZatcaSubmissionStatus @default(NOT_SENT)
  zatcaResponseCode     String?
  zatcaResponseMessage  String?
  warnings              Json?
  errors                Json?
  zatcaRawRequest       String?
  zatcaRawResponse      String?
  submittedAt           DateTime?
  lastTriedAt           DateTime?
  retryCount            Int                   @default(0)
  traceId               String?
  zatcaUuid             String?
  credentialId          String?
  qrPayloads            ZatcaQrPayload[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@index([invoiceId])
  @@index([status])
  @@index([submittedAt])
  @@index([docType])
}

model ZatcaQrPayload {
  id                  String            @id @default(uuid())
  invoiceId           String
  invoice             Invoice           @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  submissionId        String?
  submission          ZatcaSubmission?  @relation(fields: [submissionId], references: [id])
  qrBase64            String
  qrVersion           ZatcaQrVersion    @default(PHASE1_MIN)
  generatedAt         DateTime          @default(now())

  @@index([invoiceId])
  @@index([submissionId])
}

model ZatcaLog {
  id                String    @id @default(uuid())
  action            String
  environment       String?
  endpoint          String?
  requestPayload    String?
  responsePayload   String?
  responseCode      Int?
  errorMessage      String?
  invoiceId         String?
  submissionId      String?
  credentialId      String?
  userId            String?
  ipAddress         String?
  duration          Int?
  createdAt         DateTime  @default(now())

  @@index([action])
  @@index([invoiceId])
  @@index([createdAt])
}

// ==================== ANNOUNCEMENTS ====================

enum AnnouncementSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AnnouncementPublishMode {
  IMMEDIATE
  SCHEDULED
}

enum AnnouncementAudienceType {
  ROLE
  CUSTOMER
  USER
}

enum AnnouncementStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  EXPIRED
}

model Announcement {
  id              String                    @id @default(uuid())
  title           String
  body            String                    @db.Text
  severity        AnnouncementSeverity      @default(INFO)
  publishMode     AnnouncementPublishMode   @default(IMMEDIATE)
  status          AnnouncementStatus        @default(DRAFT)
  startAt         DateTime?
  endAt           DateTime?
  isPublished     Boolean                   @default(false)
  createdById     String
  createdBy       User                      @relation("AnnouncementCreatedBy", fields: [createdById], references: [id])
  audiences       AnnouncementAudience[]
  deliveries      AnnouncementDelivery[]
  sendEmail       Boolean                   @default(false)
  sendSms         Boolean                   @default(false)
  sendWhatsapp    Boolean                   @default(false)
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  @@index([status])
  @@index([isPublished])
  @@index([startAt])
  @@index([endAt])
  @@index([severity])
}

model AnnouncementAudience {
  id              String                    @id @default(uuid())
  announcementId  String
  announcement    Announcement              @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  audienceType    AnnouncementAudienceType
  roleCode        String?
  customerId      String?
  customer        Customer?                 @relation(fields: [customerId], references: [id])
  userId          String?
  user            User?                     @relation("AnnouncementAudienceUser", fields: [userId], references: [id])
  createdAt       DateTime                  @default(now())

  @@index([announcementId])
  @@index([audienceType])
  @@index([roleCode])
  @@index([customerId])
  @@index([userId])
}

model AnnouncementDelivery {
  id              String        @id @default(uuid())
  announcementId  String
  announcement    Announcement  @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId          String
  user            User          @relation("AnnouncementDeliveryUser", fields: [userId], references: [id])
  deliveredAt     DateTime      @default(now())
  isRead          Boolean       @default(false)
  readAt          DateTime?
  isDismissed     Boolean       @default(false)
  dismissedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@index([isRead])
  @@index([isDismissed])
}
