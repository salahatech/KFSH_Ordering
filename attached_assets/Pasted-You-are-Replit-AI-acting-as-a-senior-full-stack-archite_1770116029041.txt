You are Replit AI acting as a senior full-stack architect and product engineer.

Context:
We already have a working RadioPharma OMS app (orders → planning → batch → QC → QP release → dispatch → delivery + finance). Enhance it to align with the “Cyclotron Department ERP High Level Requirements (HLD)” for a radiopharmaceutical manufacturing facility.

Core Enhancements Required (must implement end-to-end):
A) Minutes-based Capacity & Reservations (bottleneck = dispensing/fulfillment minutes)
B) Dispensing gate: dispensing can happen ONLY after batch release
C) Patient privacy: ERP stores ONLY pseudonym/hospital order reference (no patient identifiers)
D) Batch granularity: one batch can fulfill multiple patient doses (DoseUnits)
E) Quality Management + Batch-level disposition (Hold/Release/Reject) with e-signature
F) Immutable audit trail + segregation of duties (SoD)
G) End-to-end genealogy (supplier lots → batch → DoseUnits → shipped)
H) Reporting & KPIs: reserved vs committed minutes, utilization, release lead time, yield, OTIF

TECH STACK (keep consistent with existing app)
- Frontend: React + TypeScript
- Backend: Node.js (NestJS preferred; Express ok) + TypeScript
- DB: PostgreSQL + Prisma
- Auth: JWT + RBAC
- Optional: Redis for events/queues
- Provide migrations + seed updates + README “enhancement demo flow”

============================================================
1) DATA MODEL UPDATES (PRISMA) — MUST ADD/UPDATE
1.1 Capacity & Reservations
- ResourceCalendar: id, resourceType (DISPENSING_BOTTLENECK, HOT_CELL, QC_LAB optional), name, timezone, isActive
- DeliveryWindow: id, calendarId, date, startTime, endTime, totalMinutes
- DeliverySlot (optional but implement structure): id, windowId, startTime, endTime, totalMinutes
- TimeStandard: id, productId, doseForm (e.g., per dose), minutesRequired (integer), effectiveFrom, effectiveTo, isActive
- Reservation: id, customerId, productId, windowId, slotId nullable, reservedMinutes, status (HELD, CONFIRMED, EXPIRED, CANCELLED), expiresAt, createdBy
Rules:
- Reservations consume minutes capacity and prevent overbooking.
- Support both “Window-only” and “Slot” models.

1.2 Orders & Dose Units
- Update Order:
  - add hospitalOrderReference (string) used as pseudonym (no patient identifiers)
  - add reservationId nullable
  - add committedDispensingMinutes (integer) (computed once order is scheduled/confirmed)
- Add DoseUnit:
  - id, orderId, batchId, productId, labelData JSON, activityAtCalibration, calibrationTime, status (PLANNED, DISPENSED, PACKED, SHIPPED)
  - releaseInheritedFromBatch (boolean) or computed
Rules:
- DoseUnits can only be created from a Batch with status RELEASED.

1.3 Batch Execution + Genealogy
- Ensure batch can link multiple orders:
  - BatchOrder join (already) + add DoseUnit relation.
- MaterialLot usage:
  - BatchMaterialLot join: batchId, materialLotId, quantity, unit
- Shipment genealogy:
  - ShipmentDoseUnit join (doseUnitId, shipmentId)

1.4 Quality Management & Release
- Add QMS entities (lightweight LIMS/QMS):
  - Sample: id, batchId, sampleType, takenAt, takenBy
  - TestSpec: id, productId, testName, unit, min, max, required
  - TestResult: id, sampleId, testSpecId, value, passFail, measuredAt, analystId
  - OOSCase (optional but structure): id, batchId, openedAt, reason, status
- ReleaseManagement:
  - BatchDisposition: HOLD/RELEASE/REJECT
  - BatchReleaseSignature: id, batchId, disposition, signedByUserId, signedAt, meaning (QP release), comment

1.5 Security/IAM & Audit (Immutable)
- AuditLog (immutable append-only):
  - id, entityType, entityId, action, actorUserId, actorRole, timestampUTC, before JSON, after JSON, traceId
- ESignature:
  - id, scope (BATCH_RELEASE, DEVIATION_APPROVAL, MASTERDATA_CHANGE, PO_APPROVAL), entityId, signedByUserId, signedAt, meaning, comment
- Enforce SoD:
  - QP cannot be the same user who performed QC entry for the same batch (configurable rule)
  - critical changes require e-signature (batch disposition, recipe/version, pricing, etc.)

============================================================
2) BUSINESS LOGIC ENHANCEMENTS — MUST IMPLEMENT
2.1 Availability & Reservation Flow
- Publish DeliveryWindows (minutes capacity) per day for DISPENSING_BOTTLENECK calendar.
- Customer portal shows available windows/slots with remaining minutes.
- Reservation creation:
  - user selects product + requested delivery window/slot + quantity/dose count
  - system calculates reservedMinutes using TimeStandard (minutesRequired × quantity)
  - if enough minutes remain → create Reservation HELD with expiresAt (e.g., 15 minutes)
  - when customer submits an order referencing Reservation → mark CONFIRMED
  - if expiresAt reached and not confirmed → EXPIRED and minutes released

2.2 Order-to-Production Planning Integration
- “Capacity control basis”: reservations consume dispensing minutes.
- When order is validated/scheduled:
  - committedDispensingMinutes = reservedMinutes (or recomputed if order changes)
  - planner view must show:
    - reserved minutes vs committed minutes per window/day
    - utilization (%) = (reserved/total) and (committed/total)
- Prevent overbooking:
  - any update that increases minutes must re-check availability.

2.3 Dispensing Gate (Hard Rule)
- DoseUnit creation and “Dispense” action is blocked unless:
  - batch disposition = RELEASED
- If batch is HOLD or REJECT:
  - DoseUnits inherit and are blocked from shipping.

2.4 Batch-level QC Disposition
- QC results are recorded at batch level; DoseUnits inherit release status.
- Implement Hold/Release/Reject workflow with QP e-signature.

2.5 Notifications (Event-driven)
Add domain events and notifications (in-app + email optional):
- Reservation held/confirmed/expired
- Order submitted/validated/scheduled
- Batch moved to QC_PENDING
- Batch released/held/rejected
- Dispensing completed
- Shipment dispatched/delivered
Maintain notification logs and templates.

============================================================
3) UI/UX ENHANCEMENTS — MUST IMPLEMENT SCREENS
3.1 Customer Portal
- “Book Capacity” screen:
  - calendar view of DeliveryWindows + remaining minutes
  - optional slot selection
  - shows minutes calculation and reservation expiry countdown
- “Create Order”:
  - optionally starts from a reservation
  - stores hospitalOrderReference (pseudonym)
- “Order Journey” tracking:
  - status stepper + timeline including reservation → order → batch → release → dispensing → shipping → delivery

3.2 Internal Screens
- Capacity Admin:
  - ResourceCalendar CRUD
  - DeliveryWindows/Slots creation (minutes)
  - TimeStandard management (minutes per product/dose form) with effective dates
- Validation Queue:
  - license/permitted products checklist
  - credit check hook (if finance enabled)
- Planner:
  - daily view with reserved vs committed minutes
  - ability to convert confirmed orders into batch plans
- Batch eBR (basic):
  - steps checklist, yields, deviations (basic capture)
- QC Dashboard:
  - sampling + results entry + pass/fail
  - OOS flagging
- Release Management:
  - batch disposition (Hold/Release/Reject) + QP e-signature
  - enforce SoD rule checks
- Dispensing & Fulfillment:
  - create DoseUnits from released batch only
  - label data + print integration placeholder (ZPL/PDF output)
- Logistics:
  - packing, chain-of-custody events, shipment creation, dispatch/delivery confirmation
- Audit Viewer:
  - filter by entity, actor, date, traceId

3.3 UX Rules
- Every step appears as a “journey” with next actions and responsibility.
- Show remaining minutes and overbooking errors with helpful guidance.
- No technical errors shown to end users; use standardized error codes + userMessage.

============================================================
4) REPORTING & KPIs — MUST ADD
- Reserved vs committed minutes by day/window (chart/table)
- Utilization trends (weekly/monthly)
- Release lead time: production end → batch release
- Yield per batch (planned vs actual)
- OTIF: on-time in-full deliveries
- Genealogy query endpoint and UI: supplier lots → batch → DoseUnits → shipment

============================================================
5) INTEGRATION PLACEHOLDERS (DO NOT OVERBUILD)
- Label printing: generate ZPL or PDF payload from DoseUnit labelData (stub ok)
- Lab instruments: allow import of results via CSV/API later (structure only)
- SSO/MFA: keep RBAC + mention extension points

============================================================
6) DELIVERABLES
- Updated Prisma schema + migrations
- Updated APIs + Swagger
- Updated React pages
- Seed data:
  - calendars/windows/slots for 7 days
  - time standards for 3 products
  - 10 reservations with different outcomes (confirmed/expired)
  - sample order journey that reaches Delivered
- README: “How to demo reservations and minutes capacity + dispensing gate”

Implementation order:
1) DB schema + migrations + seed
2) Reservation + capacity APIs and UI
3) Enforce dispensing gate + batch release workflow + e-sign + audit
4) Planner reserved vs committed minutes
5) DoseUnits + labeling stub + shipping genealogy
6) Dashboards/KPIs + audit viewer
